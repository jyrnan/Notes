# 第二章 应用层

# 2.1 介绍

协议可以分为两种：

- 标准应用层协议
- 非标准应用层协议：自己写，自己用

## 2.1.2 应用层模式

### 传统模式： 传统模式称为客户-服务器模式

很多传统该服务仍然在使用这种模式，包括万维网(World Wide Web，WWW)以及它的传播 媒介:超文本传输协议(HyperText Transfer Protocol，HTTP)、文件传输协议(File Transfer Protocol， FTP)、安全人机界面(Secure Shell，SSH)、电子邮件等等。

## 新模式:对等

一个称为对等模式(通常简称为 P2P 模式)的新模式已经出现，它迎合了新应用的需求

## 混合模式

# 2.2 客户-服务器模式

在客户-服务器模式中，应用层的通信是在两个运行着的应用程序之间进行的，这两个应用程 序称为进程(process):客户和服务器。

## 2.2.1 应用程序接口

如果我们需要一个进程与另一个进程通信，那么我们 就需要一个新的指令集告知 TCP/IP 协议簇的低四层打开连接，发送数据，从另一个终端接收数据， 以及关闭连接。这样的指令集通常称为应用程序接口(Application Programming Interface，API)。

程序中的接口是两个实体之间的指令集。在这种情况下，一个实体是应用层中的进程，另一个是操 作系统，操作系统封装了 TCP/IP 协议簇的前四层

其中三个是很常见的:**套接字接口**、传输层接口(Transport Layer Interface，TLI)以及 STREAM。

![Untitled](%E7%AC%AC%E4%BA%8C%E7%AB%A0%20%E5%BA%94%E7%94%A8%E5%B1%82%20241e6e738ac9470bab7c97e93f766258/Untitled.png)

我们可以使用相同的指令从套接字里读或向套接字里写入。换言之，我们只不过在向编程 语言中加入新的信源和信宿，而没有改变发送和接收数据的方式。

### 套接字

尽管套接字在行为上应该和一个终端或文件类似，但是它不是物理实体，而是一种抽象。套接字是供应用程序创建和使用的数据结构。

就应用层而言，客户进程和服务器进程间的通信是两个套接字间的通信

![Untitled](%E7%AC%AC%E4%BA%8C%E7%AB%A0%20%E5%BA%94%E7%94%A8%E5%B1%82%20241e6e738ac9470bab7c97e93f766258/Untitled%201.png)

### 套接字地址

我们需要一对套接字地址(socket address):一个本地 套接字地址和一个远程套接字地址。然而，我们需要以 TCP/IP 协议簇的标识符来定义套接字地址。

套接字地址应该是一个 IP 地址和一 个端口号的组合，

![Untitled](%E7%AC%AC%E4%BA%8C%E7%AB%A0%20%E5%BA%94%E7%94%A8%E5%B1%82%20241e6e738ac9470bab7c97e93f766258/Untitled%202.png)

## 2.2.2 使用传输层的服务

> 在TCP/IP 协议簇中有三个常见的传输层协议:UDP、TCP 以及 SCTP，
> 
- UDP：UDP 提供了无连接的、不可靠的数据包服务。
- TCP：TCP 提供面向连接的可靠的字节流传输
- SCTP：SCTP 提供了前面两个协议组合的功能

# 2.3 标准客户-服务器应用

## 2.3.1 万维网和 HTTP

**统一资源定位符**(Uniform Resource Locator，URL)

- 协议
- 主机
- 端口
- 路径

### 超文本传输协议(HTTP)

非持续与持续连接：是否创建一个新的TCP链接

### 报文格式

请求报文中的第一部分称为请求行;响应报文的第一部分称为状 态行。其他三部分在请求报文和响应报文中有相同的名称。然而，这三部分只是名称相似，它们可能含有不同的内容。我们分别讨论每一个报文类型。

![Untitled](%E7%AC%AC%E4%BA%8C%E7%AB%A0%20%E5%BA%94%E7%94%A8%E5%B1%82%20241e6e738ac9470bab7c97e93f766258/Untitled%203.png)

![Untitled](%E7%AC%AC%E4%BA%8C%E7%AB%A0%20%E5%BA%94%E7%94%A8%E5%B1%82%20241e6e738ac9470bab7c97e93f766258/Untitled%204.png)

![Untitled](%E7%AC%AC%E4%BA%8C%E7%AB%A0%20%E5%BA%94%E7%94%A8%E5%B1%82%20241e6e738ac9470bab7c97e93f766258/Untitled%205.png)

![Untitled](%E7%AC%AC%E4%BA%8C%E7%AB%A0%20%E5%BA%94%E7%94%A8%E5%B1%82%20241e6e738ac9470bab7c97e93f766258/Untitled%206.png)

`主体包含了从服务器发送给客户的文档。除非响应是一个错误报文，否则主体是存在的。`

### HTTP安全

HTTP 可以在安全套接层(SSL)上运 行。在这种情况下，HTTP 称为 HTTPS。

## 2.3.2 FTP

## 2.3.3 电子邮件

一封简单的电子邮件需要九个不同步骤

### 架构

三个不同的代理:

1. 用户代理(User Agent，UA)、
2. 报文传输代理(Mail Transfer Agent，MTA)以及 
3. 报文访问代理(Message Access Agent，MAA)

![Untitled](%E7%AC%AC%E4%BA%8C%E7%AB%A0%20%E5%BA%94%E7%94%A8%E5%B1%82%20241e6e738ac9470bab7c97e93f766258/Untitled%207.png)

### 报文访问代理:POP 和 IMAP

## 2.3.5 安全Shell

### 组件

SSH 是一个有三个组件的应用层协议

![Untitled](%E7%AC%AC%E4%BA%8C%E7%AB%A0%20%E5%BA%94%E7%94%A8%E5%B1%82%20241e6e738ac9470bab7c97e93f766258/Untitled%208.png)

**SSH 应用层协议(SSH-TRANS)**

由于 TCP 不是安全传输层协议，SSH 首先使用在 TCP 顶部创建安全链路的协议。这个新层是一个独立协议，称为 SSH-TRANS。当执行这个协议的程序被调用时，客户和服务器 首先使用 TCP 协议建立一个不安全的连接。然后，它们交换几个 安全参数在 TCP 顶部建立安全信道

**SSH 认证协议(SSH-AUTH)**

SSH 认证协议(SSH-AUTH) 在客户与服务器之间的安全信道建立以及客户端认证服务器之后，SSH 可以调用另外一个流程进行认证

**SSH 连接协议(SSH-CONN)**

在安全信道建立以及客户和服务器相互认证之后，SSH 可以调用一个执行第三个协议的软件，那就 是 SSH-CONN。SSH-CONN 协议提供的一个服务是复用。SSH-CONN 采用前两层协议创建安全信道允许客户在其上创建多个逻辑信道

### 应用

- 远程登录
- 文件传输： sftp就是通过ssh来传输文件，还有scp。

### 端口转发

SSH 端口转发机制创建了一个隧道，属于其他协议的报文可以穿过这个隧道。由于这个原因， 这个机制有时称为 SSH 隧道。

![Untitled](%E7%AC%AC%E4%BA%8C%E7%AB%A0%20%E5%BA%94%E7%94%A8%E5%B1%82%20241e6e738ac9470bab7c97e93f766258/Untitled%209.png)

FTP 客户可以使用本地站点的 SSH 客户 来与远程站点的 SSH 服务器创建安全连接。 任何从 FTP 客户到 FTP 服务器的请求都被携 带通过 SSH 客户和服务器提供的隧道。任何 从 FTP 服务器到 FTP 客户的请求都被携带通 过 SSH 客户和服务器提供的隧道

## 2.3.6 域名系统

### 封装

DNS 可以只用 UDP 或者 TCP 协议。在这两种情况下，服务器使用的熟知端口号是 53

# 2.4 对等模式

## 2.4.1 P2P网络

我们首先需要将 P2P 网络分成两类:集中式与分散式

### 集中式网络

在集中式 P2P 网络中，目录系统——列出对等结点及它们所提供的内容——使用客户-服务器 模式，但是文件存储和下载使用对等模式完成。由于这个原因，一个集中式 P2P 网络有时称为混 合 P2P 网络。集中式 P2P 网络的一个例子是 **Napster**。

![Untitled](%E7%AC%AC%E4%BA%8C%E7%AB%A0%20%E5%BA%94%E7%94%A8%E5%B1%82%20241e6e738ac9470bab7c97e93f766258/Untitled%2010.png)

中心服务器易受攻击并且如果中心服务器全都失效，那么整个系统就会瘫痪。

### 分散式网络

分散式 P2P 网络并不依赖中心化目录系统。在这个模式中，对等结点将自身置于覆盖网(overlay network)中。覆盖网是一个逻辑网，在物理网的顶层创建。依照覆盖网中结点连接方式，分散式 P2P 网络分为非结构化和结构化两种。

结构化网络采用一组预先确定的规则来连接结点，有效并高效地解决查询。最常用的技术是分 布式散列表(Distributed Hash Table，DHT)。DHT 应用于很多应用，包括分布式数据结构(Distributed Data Structure，DDS)、内容分发系统(Content Distributed Systems，CDS)、域名系统(Domain Name System，DNS)以及 P2P 文件共享。

## 2.4.2 分布式散列表

一个分布式散列表(Distributed Hash Table，DHT)根据预先定义的规则将数据(或引用数据) 分发到一组结点上。

## 2.4.3 Chord。。。

是一种实现分布式散列表的算法（略）还有其他若干种

## 2.4.6 BitTorrent

# 2.5 套接字编程接口

能不能看懂？😂

### 使用UDP通信

### 使用TCP通信

TCP 服务器使用两个不同的套接字，一个用于连接建立，一个用于数据传输。服务器使用监听套接字来监听试图建立连接的新客户

![Untitled](%E7%AC%AC%E4%BA%8C%E7%AB%A0%20%E5%BA%94%E7%94%A8%E5%B1%82%20241e6e738ac9470bab7c97e93f766258/Untitled%2011.png)
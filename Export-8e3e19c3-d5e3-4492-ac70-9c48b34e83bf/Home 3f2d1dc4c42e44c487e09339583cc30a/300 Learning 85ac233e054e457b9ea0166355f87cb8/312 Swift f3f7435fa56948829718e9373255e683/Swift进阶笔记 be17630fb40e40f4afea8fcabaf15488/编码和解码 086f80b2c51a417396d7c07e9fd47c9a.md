# ç¼–ç å’Œè§£ç 

# èŒƒä¾‹

## Ecoding

Swiftè‡ªå¸¦ä¸¤ä¸ªç¼–ç å™¨ï¼Œåˆ†åˆ«æ˜¯JSONEnCoderå’ŒPropertyListEncoder ï¼ˆäºŒè€…å®šä¹‰åœ¨foundationä¸­è€Œä¸æ˜¯æ ‡å‡†åº“ï¼Ÿå•¥æ„æ€ï¼‰

å®ç°äº†Codableçš„ç±»å‹å’ŒCocoaä¸­çš„NSKeyedArchiveræ˜¯å…¼å®¹çš„

## Decoding

å’Œencodingäº’é€†

<aside>
ğŸ¤”  encodingï¼š ä»typeè½¬åˆ°dataï¼Œ //dataå¯ä»¥è½¬æ¢æˆstringæ¥æ˜¾ç¤ºè€Œå·²ã€‚
decodingï¼š ä»dataè½¬åˆ°type

</aside>

## è‡ªå®šä¹‰ç¼–ç æ ¼å¼

ä½¿ç”¨å±æ€§åŒ…è£…æ¥ä¸ºç‰¹å®šçš„å±æ€§è‡ªå®šä¹‰ç¼–ç å’Œè§£ç è¿‡ç¨‹æœ‰ä¸¤ä¸ªå·¨å¤§ä¼˜åŠ¿ï¼šé¦–å…ˆï¼Œé»˜è®¤çš„ç¼–è§£ç è¡Œä¸ºä¾ç„¶å¯¹å…¶ä»–æ‰€æœ‰å±æ€§ç”Ÿæ•ˆ (åœ¨æˆ‘ä»¬çš„ Coordinate ä¾‹å­ä¸­ï¼Œå·²ç»æ²¡æœ‰å…¶ä»–å±æ€§äº†ï¼Œä½†æ˜¯åœ¨çœŸå®ä¸–ç•Œé‡Œï¼Œä½ é€šå¸¸åªä¼šéœ€è¦å¯¹å¥½å¤šå±æ€§ä¸­çš„ä¸€ä¸ªè¿›è¡Œè‡ªå®šä¹‰)ã€‚ç¬¬äºŒç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨å…¶ä»–åœ°æ–¹é‡ç”¨åƒæ˜¯ CodedAsString è¿™æ ·çš„å˜å½¢ã€‚

```swift
@propertyWrapper
struct CodedAsString: Codable {
    var wrappedValue: Double
    init(wrappedValue: Double) {
        self.wrappedValue = wrappedValue
    }
    
    init(from decoder: Decoder) throws {
        let container = try decoder.singleValueContainer() //è¿™ä¸ªä¸æ˜ç™½ï¼
        let str = try container.decode(String.self)
        guard let value = Double(str) else {
            let error = EncodingError.Context(codingPath: container.codingPath, debugDescription: "Invalid string represenation of double value")
            throw EncodingError.invalidValue(str, error)
        }
        
        wrappedValue = value
    }
    
    func encode(to encoder: Encoder) throws {
        var container = encoder.singleValueContainer()
        try container.encode(wrappedValue)
    }
```

# ç¼–ç è¿‡ç¨‹

<aside>
ğŸ¤” **åŸºæœ¬æ­¥éª¤ï¼š**

1. åˆ›å»ºCodingKeys
2. åˆ†åˆ«å®ç°encode(to:)å’Œinit(from:)
3. ä¸»è¦é€‰æ‹©containerç±»å‹
4. åŸºæœ¬éƒ½æ˜¯è¦try
</aside>

ä½ å¼€å§‹ç¼–ç è¿‡ç¨‹æ—¶ï¼Œç¼–ç å™¨ä¼šè°ƒç”¨æ­£åœ¨è¢«ç¼–ç çš„å€¼ä¸Šçš„ encode(to: Encoder) æ–¹æ³•ï¼Œå¹¶å°†è‡ªèº«ä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ƒã€‚æ¥ä¸‹æ¥ï¼Œå¦‚ä½•ç”¨ç¼–ç å™¨è¿›è¡Œæ­£ç¡®çš„ç¼–ç ï¼Œå°±æ˜¯å€¼è‡ªèº«çš„è´£ä»»äº†ã€‚

## å®¹å™¨

```swift
/// ä¸€ä¸ªå¯ä»¥æŠŠå€¼ç¼–ç æˆæŸç§å¤–éƒ¨è¡¨ç°å½¢å¼çš„ç±»å‹ã€‚
public protocol Encoder {
/// ç¼–ç åˆ°å½“å‰ä½ç½®çš„ç¼–ç é”® (coding key) è·¯å¾„
var codingPath: [CodingKey] { get }
/// ç”¨æˆ·ä¸ºç¼–ç è®¾ç½®çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚
var userInfo: [CodingUserInfoKey : Any] { get }
/// è¿”å›ä¸€ä¸ªå®¹å™¨ï¼Œç”¨äºå­˜æ”¾å¤šä¸ªç”±ç»™å®šé”®ç´¢å¼•çš„å€¼ã€‚
func container<Key: CodingKey>(keyedBy type: Key.Type)
-> KeyedEncodingContainer<Key>
/// è¿”å›ä¸€ä¸ªå®¹å™¨ï¼Œç”¨äºå­˜æ”¾å¤šä¸ªæ²¡æœ‰é”®ç´¢å¼•çš„å€¼ã€‚
func unkeyedContainer() -> UnkeyedEncodingContainer
/// è¿”å›ä¸€ä¸ªé€‚åˆå­˜æ”¾å•ä¸€å€¼çš„ç¼–ç å®¹å™¨ã€‚
func singleValueContainer() -> SingleValueEncodingContainer
}
```

ä¸‰ç§å®¹å™¨

- é”®å®¹å™¨ï¼šæ–¹æ³•æ›´å¤æ‚ï¼Œå‚è€ƒ

[Apple Developer Documentation](https://developer.apple.com/documentation/swift/keyedencodingcontainer)

- æ— é”®å®¹å™¨

[Apple Developer Documentation](https://developer.apple.com/documentation/swift/unkeyedencodingcontainer)

- å•å€¼ï¼ˆåŸå§‹å€¼ï¼‰å®¹å™¨

```swift
/// æ”¯æŒå­˜å‚¨å’Œç›´æ¥ç¼–ç æ— ç´¢å¼•å•ä¸€å€¼çš„å®¹å™¨ã€‚
public protocol SingleValueEncodingContainer {
/// ç¼–ç åˆ°å½“å‰ä½ç½®çš„ç¼–ç é”®è·¯å¾„ã€‚
var codingPath: [CodingKey] { get }
/// ç¼–ç ç©ºå€¼ã€‚
mutating func encodeNil() throws
/// ç¼–ç åŸå§‹ç±»å‹çš„æ–¹æ³•
mutating func encode(_ value: Bool) throws
mutating func encode(_ value: Int) throws
mutating func encode(_ value: Int8) throws
mutating func encode(_ value: Int16) throws
mutating func encode(_ value: Int32) throws
mutating func encode(_ value: Int64) throws
mutating func encode(_ value: UInt) throws
mutating func encode(_ value: UInt8) throws
mutating func encode(_ value: UInt16) throws
mutating func encode(_ value: UInt32) throws
mutating func encode(_ value: UInt64) throws
mutating func encode(_ value: Float) throws
mutating func encode(_ value: Double) throws
mutating func encode(_ value: String) throws
mutating func encode<T: Encodable>(_ value: T) throws //è¿™ä¸ªæ–¹æ³•æ˜¯æ³›å‹é€šç”¨æ–¹æ³•ï¼Œä¾‹å¦‚è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„å°±é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥é€’å½’å®ç°ã€‚
}
```

# åˆæˆçš„ä»£ç 

## Coding Keys

â€œé¦–å…ˆï¼Œåœ¨ Placemarké‡Œï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ªå«åš CodingKeys çš„ç§æœ‰æšä¸¾ç±»å‹ï¼š

```swift
struct Placemark {
	// ...
	private enum CodingKeys: CodingKey {
		case name
		case coordinate
	}
}
```

â€œè¿™ä¸ªæšä¸¾åŒ…å«çš„æˆå‘˜ä¸ç»“æ„ä½“ä¸­çš„å­˜å‚¨å±æ€§ä¸€ä¸€å¯¹åº”ã€‚è€Œæšä¸¾å€¼å³ä¸ºé”®å®¹å™¨ç¼–ç å¯¹è±¡æ—¶ä½¿ç”¨çš„é”®ã€‚â€

```swift
/// è¯¥ç±»å‹ä½œä¸ºç¼–ç å’Œè§£ç æ—¶ä½¿ç”¨çš„é”®
public protocol CodingKey {
	/// åœ¨ä¸€ä¸ªå‘½åé›†åˆ (ä¾‹å¦‚ï¼šä»¥å­—ç¬¦ä¸²ä½œä¸ºé”®çš„å­—å…¸) ä¸­çš„å­—ç¬¦ä¸²å€¼ã€‚
	var stringValue: String { get }
	/// åœ¨ä¸€ä¸ªæ•´æ•°ç´¢å¼•çš„é›†åˆ (ä¸€ä¸ªæ•´æ•°ä½œä¸ºé”®çš„å­—å…¸) ä¸­ä½¿ç”¨çš„å€¼ã€‚
	var intValue: Int? { get }
	init?(stringValue: String)
	init?(intValue: Int)
}
```

â€œæ‰€æœ‰é”®éƒ½å¿…é¡»å¯ä»¥ç”¨å­—ç¬¦ä¸²çš„å½¢å¼è¡¨ç¤ºï¼Œå¦å¤–ï¼Œä¸€ä¸ªé”®ç±»å‹ä¹Ÿå¯ä»¥æä¾›å’Œæ•´æ•°äº’ç›¸è½¬æ¢çš„èƒ½åŠ›ã€‚â€

è¿™ä¸ªçš„ç›®çš„æ˜¯ï¼šå› ä¸ºCodingKeyå¯ä»¥ç”¨æ¥æŸ¥æ‰¾å¯¹åº”çš„å€¼ï¼Œæ‰€ä»¥è¦ä¹ˆä»¥å­—ç¬¦ä¸²ä½œä¸ºå­—å…¸çš„é”®å€¼æ¥æŸ¥æ‰¾æ•°æ®ï¼Œè¦ä¹ˆä»¥æ•´æ•°ä½œä¸ºç´¢å¼•ä½ç½®æ¥æŸ¥æ‰¾arrayä¸­çš„æ•°æ®ã€‚

## encode(to:)æ–¹æ³•

ä¸‹é¢æ˜¯**ç¼–è¯‘å™¨ä¸ºPlacemarkç»“æ„ä½“ç”Ÿæˆ**çš„encode(to:)æ–¹æ³•

```swift
struct Placemark: Codable {
	// ...
	func encode(to encoder: Encoder) throws {
		var container = encoder.container(keyedBy: CodingKeys.self) //å…ˆåˆ›å»ºcontainer
		try container.encode(name, forKey: .name)
		try container.encode(coordinate, forKey: .coordinate)
	}
}
```

**ç¼–ç è¿‡ç¨‹çš„ç»“æœï¼Œæœ€ç»ˆæ˜¯ä¸€æ£µåµŒå¥—çš„å®¹å™¨æ ‘ã€‚JSON ç¼–ç å™¨å¯ä»¥æ ¹æ®æ ‘ä¸­èŠ‚ç‚¹çš„ç±»å‹æŠŠè¿™ä¸ªç»“æœè½¬æ¢æˆå¯¹åº”çš„ç›®æ ‡æ ¼å¼ï¼šé”®å®¹å™¨ä¼šå˜æˆ JSON å¯¹è±¡ ({ â€¦ })ï¼Œæ— é”®å®¹å™¨å˜æˆ JSON æ•°ç»„ ([ â€¦ ])ï¼Œå•å€¼å®¹å™¨åˆ™æŒ‰ç…§å®ƒä»¬çš„æ•°æ®ç±»å‹ï¼Œè¢«è½¬æ¢ä¸ºæ•°å­—ï¼Œå¸ƒå°”å€¼ï¼Œå­—ç¬¦ä¸²æˆ–è€…nul**

<aside>
ğŸ¤” æ‰€ä»¥ï¼Œå…¶å®JSONçš„ç»“æ„ç§ç±»ä¹Ÿå°±æ˜¯ä¸‰ç§ï¼š
å­—å…¸ï¼šå¯¹åº”å¤æ‚object
æ•°ç»„ï¼šåºåˆ—ï¼ˆä¸çŸ¥åˆ°è¡¨è¿°ï¼‰
å•å€¼ï¼šåŸå§‹å€¼

</aside>

## init(from:)åˆå§‹åŒ–æ–¹æ³•

å’Œencodeåˆšå¥½åè¿‡æ¥ã€‚

â€œè§£ç å™¨ä¹Ÿç®¡ç†ä¸€æ£µç”±è§£ç å®¹å™¨ (decoding containers) æ„æˆçš„æ ‘ï¼Œæ ‘ä¸­æ‰€åŒ…å«çš„å®¹å™¨æˆ‘ä»¬å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œå®ƒä»¬è¿˜æ˜¯é”®å®¹å™¨ï¼Œæ— é”®å®¹å™¨ï¼Œä»¥åŠå•å€¼å®¹å™¨ã€‚â€

â€œæ¯ä¸ªè¢«è§£ç çš„å€¼ä¼šä»¥**é€’å½’**æ–¹å¼å‘ä¸‹è®¿é—®å®¹å™¨çš„å±‚çº§ï¼Œå¹¶ä¸”ä½¿ç”¨ä»å®¹å™¨ä¸­è§£ç å‡ºæ¥çš„å€¼åˆå§‹åŒ–å¯¹åº”çš„å±æ€§ã€‚å¦‚æœæŸä¸ªæ­¥éª¤å‘ç”Ÿäº†é”™è¯¯ (æ¯”å¦‚ç”±äºç±»å‹ä¸åŒ¹é…æˆ–è€…å€¼ä¸å­˜åœ¨)ï¼Œé‚£ä¹ˆæ•´ä¸ªè¿‡ç¨‹éƒ½ä¼šå¤±è´¥ï¼Œå¹¶æŠ›å‡ºé”™è¯¯ã€‚â€

```swift
struct Placemark: Codable {
	// ...
	init(from decoder: Decoder) throws {
		let container = try decoder.container(keyedBy: CodingKeys.self)
		name = try container.decode(String.self, forKey: .name)
		coordinate = try container.decode(Coordinate.self, forKey: .coordinate)
	}
}
```

# æ‰‹åŠ¨éµå®ˆåè®®

## è‡ªå®šä¹‰Coding Keys

è‡ªåŠ¨åˆæˆçš„ä»£ç ä½¿ç”¨enumæ¥å®ç°CodingKeyåè®®ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥æ˜¯åˆ«çš„ã€‚é€šè¿‡å¯ä»¥

- ç¼–ç è¿‡ç¨‹ä¸­ç”¨æŒ‡å®šå­—ç¬¦ä¸²**é‡å‘½åå­—æ®µ**
- å°†æŸä¸ªé”®ä»æšä¸¾ä¸­ç§»é™¤ä»¥æ­¤**è·³è¿‡ä¸ä¹‹å¯¹åº”å­—æ®µ**

```swift
struct Placemark3: Codable {
    var name: String
    var coordinate: Coordinate
    
    private enum CodingKeys: String, CodingKey {
        case name = "label"
        case coordinate
    }
    
    //ç¼–è¯‘å™¨åˆæˆçš„encodeå’Œdecodeæ–¹æ³•å°†ä½¿ç”¨è¦†ç›–åçš„CodingKeys
}
```

å¿½ç•¥æŸä¸ªå±æ€§çš„èŒƒä¾‹

```swift
struct Placemark3: Codable
{
    var name: String = "Unknow"
    var coordinate: Coordinate
    
    private enum CodingKeys: CodingKey {
        case coordinate
    }
}
```

ä¸Šä¾‹ä¸­ç»™nameæœ‰ä¸€ä¸ªé»˜è®¤å±æ€§ã€‚å› ä¸ºé”®å€¼ä¸­å»æ‰äº†nameé¡¹ï¼Œæ‰€ä»¥ç¼–ç è¿‡ç¨‹ä¸­ä¸è€ƒè™‘å®ƒäº†ã€‚å¦‚æœnameé¡¹æ²¡æœ‰é»˜è®¤å€¼ï¼Œé‚£åœ¨åˆå§‹åŒ–æ—¶å€™å°±æ— æ³•æ­£ç¡®èµ‹å€¼äº†ã€‚

## è‡ªå®šä¹‰çš„encode(to:) & init(from:)å®ç°

ä¾‹å¦‚ä¸‹é¢

```swift
struct Placemark4: Codable {
    var name:String
    var coordinate: Coordinate? //è¿™é‡Œå¯ä»¥æ˜¯nil
}
```

é»˜è®¤çŠ¶æ€ä¸‹åˆå§‹åŒ–çš„æ—¶å€™å¯ä»¥ä¸æä¾›coordinateé€‰é¡¹ï¼Œä¼šè‡ªåŠ¨ç”¨nilå¡«å……ã€‚

ä½†æ˜¯JSONæœ‰æ—¶å€™ä¼šç”¨**ç©ºå¯¹è±¡**æ¥è¡¨ç¤ºå¯é€‰å€¼ç©ºç¼ºï¼Œè¿™å°±åè€Œä¼šå‡ºç°é”™è¯¯

```json
â€œlet invalidJSONInput = """
    [
        {
            "name" : "Berlin",
            "coordinate": {} //ç©ºç¼ºå€¼ï¼ğŸ¤¦â€â™‚ï¸
        }
    ]
    ""â€
```

æ‰€ä»¥éœ€è¦é‡è½½Decodableæ–¹æ³•

```swift
struct Placemark4: Codable {
    var name:String
    var coordinate: Coordinate?
    
    //encode(to:)ä¾ç„¶ç”±ç¼–è¯‘å™¨åˆæˆ
    
    init(from decoder: Decoder) throws {
        let container = try decoder.container(keyedBy: CodingKeys.self)
        self.name = try container.decode(String.self, forKey: .name)
        do {
            self.coordinate = try container.decodeIfPresent(Coordinate.self, forKey: .coordinate)
        } catch DecodingError.keyNotFound {
            self.coordinate = nil
        }
    }
}
```

 å¯ä»¥é€šè¿‡ç¼–å†™ä¸€ä¸ªå¯é€‰å€¼çš„è‡ªå®šä¹‰ç¼–ç è§£ç æ–¹æ³•ã€‚ç„¶ååœ¨å±æ€§å‰åº”ç”¨å³å¯

```swift
@propertyWrapper
struct NilWhenKeyNotFound<Value: Codable>: Codable {
    var wrappedValue: Value?
    init(wrppedValue: Value?) {
        self.wrappedValue = wrppedValue
    }
    
		///è¿™æ®µencodeæ˜¯è‡ªå·±å‚è€ƒå†™çš„ï¼Œæ­£ç¡®æ€§æœªéªŒè¯
    func encode(to encoder: Encoder) throws {
        
            var container = encoder.singleValueContainer()
        guard let wrappedValue else {
            try container.encodeNil()
            return
        }
        try container.encode(wrappedValue)
    }
    
    init(from decoder: Decoder) throws {
        do {
            let container = try decoder.singleValueContainer()
            self.wrappedValue = try container.decode(Value.self)
        } catch DecodingError.keyNotFound {
            wrappedValue = nil
        }
    }
}
```

ç”¨æ³•å¦‚ä¸‹

```swift
struct Placemark5: Decodable {
    var name: String
    @NilWhenKeyNotFound var coodinate: Coordinate?
}
```

# å¸¸è§çš„ç¼–ç ä»»åŠ¡

# è®©å…¶ä»–äººçš„ä»£ç æ»¡è¶³Codable

â€œApple çš„å·¥ç¨‹å¸ˆ Itai Ferber å†™äº†å¾ˆå¤šå…³äº Codable ç³»ç»Ÿçš„ä¸œè¥¿ï¼Œä»–ç»™å‡ºäº†è¿™æ ·çš„å»ºè®®ï¼š

å®é™…ä¸Šæˆ‘ä¼šæ›´è¿›ä¸€æ­¥ï¼Œå¹¶ä¸”å»ºè®®åœ¨å½“ä½ æƒ³è¦æ‰©å±•åˆ«äººçš„ç±»å‹ï¼Œä½¿å…¶æ»¡è¶³ Encodable æˆ– Decodable æ—¶ï¼Œä½ å‡ ä¹æ€»æ˜¯åº”è¯¥è€ƒè™‘å†™ä¸€ä¸ªç»“æ„ä½“æŠŠå®ƒå°è£…èµ·æ¥ï¼Œé™¤éä½ æœ‰ç†ç”±èƒ½å¤Ÿç¡®ä¿¡è¿™ä¸ªç±»å‹è‡ªå·±ç»å¯¹ä¸ä¼šå»éµå¾ªè¿™äº›åè®®ã€‚

â€

```swift
import CoreLocation

struct Placemark5: Codable {
    var name: String
    var coordinate: CLLocationCoordinate2D? //ä¸ç¬¦åˆCodableï¼Œéœ€è¦è‡ªå·±å†™
}

//è‡ªå·±å®ç°
extension Placemark5 {
    private enum CodingKeys: String, CodingKey {
        case name
        case latitude = "lat"
        case longitude = "lon"
    }
    
    func encode(to encoder: Encoder) throws {
        var container = encoder.container(keyedBy: CodingKeys.self)
        try container.encode(name, forKey: .name)
        try container.encode(coordinate?.latitude, forKey: .latitude)
        try container.encode(coordinate?.longitude, forKey: .longitude)
    }
    
    init(from decoder: Decoder) throws {
        let container = try decoder.container(keyedBy: CodingKeys.self)
        self.name = try container.decode(String.self, forKey: .name)
        self.coordinate = CLLocationCoordinate2D(
            latitude: try container.decode(Double.self, forKey: .latitude),
            longitude: try container.decode(Double.self, forKey: .longitude)
        )
    }
}
```

â€œä¸Šé¢è¿™ä¸ªä¾‹å­å°±å¾ˆå¥½åœ°å±•ç¤ºäº†å½“ç¼–è¯‘å™¨æ— æ³•è‡ªåŠ¨ç”Ÿæˆ Codable å®ç°æ—¶ (å½“ç„¶ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¹Ÿä¸ä¼šä¸ºæˆ‘ä»¬åˆæˆå®ç° CodingKey åè®®çš„ä»£ç )ï¼Œæˆ‘ä»¬ä¸å¾—ä¸ä¸ºæ¯ä¸ªç±»å‹æ‰‹å·¥ç¼–å†™çš„ä»£ç æ¨¡æ¿ã€‚â€

åŸä¹¦è¿˜æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥è¿›ä¸€æ­¥äº†è§£ã€‚

## è®©ç±»æ»¡è¶³Codabe

â€œä¸ºä¸å±äºä½ çš„ç±»å‹æ·»åŠ  Codable è¿˜æ˜¯é—®é¢˜é‡é‡ï¼Œæˆ‘ä»¬å¿…é¡»è¦é¢å¯¹è¿™ä¸ªäº‹å®ã€‚ä¸Šä¸€èŠ‚è¯´è¿‡ï¼Œæ¨èçš„æ–¹å¼æ˜¯å†™ä¸€ä¸ªç»“æ„ä½“æ¥å°è£… UIColorï¼Œå¹¶ä¸”å¯¹è¿™ä¸ªç»“æ„ä½“è¿›è¡Œç¼–è§£ç ã€‚
â€

```swift
@propertyWrapper
struct CodedAsRGBA: Codable {
    private var red: CGFloat = 0
    private var green: CGFloat = 0
    private var blue: CGFloat = 0
    private var alpha: CGFloat = 0
    var wrappedValue: UIColor {
        get {UIColor(red: red, green: green, blue: blue, alpha: alpha)}
        set {store(newValue)}
    }
    
    init(wrappedValue: UIColor) {
        store(wrappedValue)
    }
    
    mutating func store(_ color: UIColor) {
        let success: Bool = color.getRed(&red, green: &green, blue: &blue, alpha: &alpha)
        if !success {fatalError("Invalid color format")}
    }
}
```

## è§£ç å¤šæ€é›†åˆ

é›†åˆä¸­å¦‚æœæ˜¯å­ç±»ï¼Œä½†æ˜¯ç”¨çˆ¶ç±»æ¥è§£ç ï¼Œä¼šå¯¼è‡´å­ç±»ä¿¡æ¯ä¸¢å¤±ã€‚

# ä¸€ä¸ªå®˜æ–¹èŒƒä¾‹è§£è¯»

è¿™æ˜¯å®˜æ–¹çš„ä¸€ä¸ªæœ€å¤æ‚çš„èŒƒä¾‹ï¼Œéœ€è¦æŠŠæ•°æ®ä»ä¸åŒçš„æ·±åº¦åˆå¹¶èµ·æ¥ã€‚

[Apple Developer Documentation](https://developer.apple.com/documentation/foundation/archives_and_serialization/using_json_with_custom_types)

## encode/decodeåŸºæœ¬æ€è·¯

åœ¨è¿™ä¸ªèŒƒä¾‹ä¸­ï¼Œå¯ä»¥äº†è§£encode/decodeåŸºæœ¬æ€è·¯ï¼š

- è®¾è®¡CodingKey
- åˆ›å»ºcontainerã€‚è¿™ä¸ªcontaineråŒ…å«äº†è¿™ä¸ªå±‚çº§æ•°æ®çš„en/decodeçš„æ–¹æ³•ã€‚
- åœ¨containeré‡Œé¢è¿›è¡ŒåŸºæœ¬å±æ€§çš„en/decodeã€‚
- å¦‚æœæ¶‰åŠåˆ°åµŒå¥—çš„containerç»“æ„ï¼Œåˆ™é€šè¿‡å¢åŠ nestedContaineræ¥å®ç°
- å¦‚æœen/decodeæ–¹æ³•ä¸­ä¸æ˜¯åŸºæœ¬æ•°æ®ç±»ï¼Œè€Œæ˜¯è‡ªå®šä¹‰æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚Valueï¼Œåˆ™é€šè¿‡`mutating func encode<T: Encodable>(_ value: T) throws` è¿™ä¸ªæ³›å‹é€šç”¨æ–¹æ³•æ¥é€’å½’å®ç°ã€‚

## èŒƒä¾‹

### æ•°æ®

è¿™ä¸ªæ•°æ®çš„åŸºæœ¬ç»“æ„æ˜¯ä¸€ä¸ªäº§å“çš„Dictionaryï¼Œç‰¹ç‚¹æ˜¯äº§å“çš„åå­—æ—¢æ˜¯keyï¼Œåˆæ˜¯valueï¼ˆäº§å“ï¼‰çš„åå­—ã€‚

```swift
import Foundation

let json = """
{
    "Banana": {
        "points": 200,
        "description": "A banana grown in Ecuador."
    },
    "Orange": {
        "points": 100
    }
}
""".data(using: .utf8)!
```

è€Œæˆ‘ä»¬å¸Œæœ›å®šä¹‰çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼Œå…¶å®æ˜¯ä¸€ä¸ªProductçš„Arrayã€‚å› æ­¤å’Œä¸Šé¢çš„æ•°æ®å…¶å®æœ‰å·®å¼‚ã€‚

è§£å†³çš„æ–¹æ³•æ˜¯åœ¨è‡ªå®šä¹‰en/decodeæ–¹æ³•ï¼Œæ¥å®ç°codableè¿‡ç¨‹ä¸­å°†keyçš„æ•°å€¼ä½œä¸ºproductçš„nameå±æ€§ï¼ŒåŒæ—¶å°†dictionaryç±»å‹æ•°æ®è½¬æ¢æˆä¸‹é¢çš„Array<Product>ç±»å‹ã€‚

```swift
struct GroceryStore {
    struct Product {
        let name: String
        let points: Int
        let description: String?
    }

    var products: [Product]

    init(products: [Product] = []) {
        self.products = products
    }
}
```

### è®¾è®¡CodingKey

é¦–å…ˆè®¾è®¡CodingKeyã€‚CodingKeyåè®®å¦‚ä¸‹ï¼Œå…·ä½“å‚è€ƒ[è¿™é‡Œ](%E7%BC%96%E7%A0%81%E5%92%8C%E8%A7%A3%E7%A0%81%20086f80b2c51a417396d7c07e9fd47c9a.md)

```swift
/// è¯¥ç±»å‹ä½œä¸ºç¼–ç å’Œè§£ç æ—¶ä½¿ç”¨çš„é”®
public protocol CodingKey {
	/// åœ¨ä¸€ä¸ªå‘½åé›†åˆ (ä¾‹å¦‚ï¼šä»¥å­—ç¬¦ä¸²ä½œä¸ºé”®çš„å­—å…¸) ä¸­çš„å­—ç¬¦ä¸²å€¼ã€‚
	var stringValue: String { get }
	/// åœ¨ä¸€ä¸ªæ•´æ•°ç´¢å¼•çš„é›†åˆ (ä¸€ä¸ªæ•´æ•°ä½œä¸ºé”®çš„å­—å…¸) ä¸­ä½¿ç”¨çš„å€¼ã€‚
	var intValue: Int? { get }
	init?(stringValue: String)
	init?(intValue: Int)
}
```

ä¸€èˆ¬Codingkeyæ˜¯é‡‡ç”¨Enumç±»å‹ï¼Œä½†æ˜¯è¿™ä¸ªCodingKeyé‡‡ç”¨äº†structç±»å‹ï¼Œè¿™æ ·å¯ä»¥åˆ›å»ºä»»æ„å¤šä¸ªCodingKeyå¤šå®ä¾‹ã€‚è¿™æ ·åšçš„åŸå› æ˜¯åŸå§‹æ•°æ®é‡Œé¢productçš„nameç›´æ¥å……å½“äº†é¡¶å±‚containerä¸­çš„keyï¼Œè€Œnameæ˜¯å¤šæ ·åŒ–ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥ç”¨structç±»æ¥æ»¡è¶³ä»»æ„ä¸ªcodingKeyçš„éœ€æ±‚ã€‚

åŒæ—¶ç”¨ä¸¤ä¸ªstaticå±æ€§æ¥åˆ›å»ºä¸¤ä¸ªå›ºå®šçš„codingKeyï¼špointså’Œdescription

```swift
extension GroceryStore: Encodable {
    struct ProductKey: CodingKey {
        var stringValue: String
        init?(stringValue: String) {
            self.stringValue = stringValue
        }

        var intValue: Int? { return nil }
        init?(intValue: Int) { return nil }

        static let points = ProductKey(stringValue: "points")!
        static let description = ProductKey(stringValue: "description")!
    }
		//encodeæ–¹æ³•åœ¨ä¸‹é¢è¡¥å……
}
```

<aside>
ğŸ¤” åŸèŒƒä¾‹ä¸­æ˜¯å…ˆencodeæ–¹æ³•ï¼Œä½†æ˜¯æˆ‘æ„Ÿè§‰å…ˆè§£é‡Šdecodeæ–¹æ³•æ›´åŠ åˆé€‚ï¼Ÿæ‰€ä»¥æˆ‘è°ƒè¿‡æ¥è§£é‡Š

</aside>

### å®ç°decodeæ–¹æ³•

è‡ªå®šä¹‰çš„decodeæ–¹æ³•ä¸­ï¼Œéœ€è¦æŠŠjsonæ–‡ä»¶ä¸­é¡¶å±‚çš„[String: Procuct]ç±»å‹è½¬æ¢æˆ[Product]ï¼Œå¹¶ä¸”jsonæ–‡ä»¶ä¸­çš„å……å½“keyçš„Stringè¿˜éœ€è¦æ”¾åˆ°Productå†…éƒ¨ä½œä¸ºnameå±æ€§ã€‚æ‰€ä»¥decodeæ–¹æ³•äº‹æŒ‰ç…§è¿™ä¸ªæ€è·¯æ¥å®ç°ã€‚

```swift
extension GroceryStore: Decodable {
    public init(from decoder: Decoder) throws {
				//åˆ›å»ºä¸€ä¸ªç©ºçš„Array
        var products = [Product]() 

				 //åˆ›å»ºç¬¬ä¸€ä¸ªcontainerï¼Œè¿™ä¸ªcontainerçš„ç±»å‹æ˜¯é”®å®¹å™¨ï¼Œé”®ç±»å‹æ˜¯ProductKey
        let container = try decoder.container(keyedBy: ProductKey.self)

        for key in container.allKeys { //è¿™é‡Œå¯ä»¥è·å–åˆ°é¡¶å±‚containeré‡Œé¢çš„æ‰€æœ‰é”®å€¼
            // Note how the `key` in the loop above is used immediately to access a nested container
						//è·å–é”®å€¼å¯¹åº”çš„åµŒå¥—å®¹å™¨
            let productContainer = try container.nestedContainer(keyedBy: ProductKey.self, forKey: key) 

						//ä»åµŒå¥—å®¹å™¨é‡Œé¢è§£ç å¯¹åº”é”®å€¼çš„å€¼ï¼Œè¿™é‡Œæ˜¯Intç±»å‹
            let points = try productContainer.decode(Int.self, forKey: .points)
						//ä»åµŒå¥—å®¹å™¨é‡Œé¢è§£ç å¯¹åº”é”®å€¼çš„å€¼ï¼Œè¿™é‡Œæ˜¯Stringç±»å‹ 
            let description = try productContainer.decodeIfPresent(String.self, forKey: .description)

            // The key is used again here and completes the collapse of the nesting that existed in the JSON representation.
						//é€šè¿‡ä¸Šé¢è·å–çš„ä¸‰ä¸ªå±æ€§åˆ›å»ºProduct
            let product = Product(name: key.stringValue, points: points, description: description) 
            products.append(product)
        }

        self.init(products: products) //ç”ŸæˆGroceryStore
    }
}
```

### å®ç°encodeæ–¹æ³•

encodeæ–¹æ³•å’Œdecodeæ–¹æ³•æ°å¥½ç›¸åï¼Œéœ€è¦æŠŠproductçš„nameå±æ€§ä½œä¸ºjsoné¡¶å±‚é”®å®¹å™¨ç±»å‹ä¸­çš„keyï¼ŒæŠŠå‰©ä½™ä¸¤ä¸ªå±æ€§pointså’Œdescriptionæ”¾åˆ°valueä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ªé¡¶å±‚çš„é”®å®¹å™¨ä¸­åˆ›å»ºä¸€ä¸ªåµŒå¥—é”®å®¹å™¨ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹

```swift
func encode(to encoder: Encoder) throws {
				//åˆ›å»ºjsonæ–‡ä»¶é¡¶å±‚çš„é”®å®¹å™¨ï¼Œkeyç±»å‹æ˜¯ProductKey
        var container = encoder.container(keyedBy: ProductKey.self) 
        
        for product in products { //å¯¹GroceryStoreç±»å‹ä¸­å®é™…æ•°æ®[Products]è¿›è¡Œè¿­ä»£æ“ä½œ
            // Any product's `name` can be used as a key name.
						//åˆ©ç”¨Product.nameæ¥åˆ›å»ºé¡¶å±‚é”®å®¹å™¨çš„key
            let nameKey = ProductKey(stringValue: product.name)! 
            var productContainer = container.nestedContainer(keyedBy: ProductKey.self, forKey: nameKey) //åœ¨é¡¶å±‚é”®å®¹å™¨ä¸­åˆ›å»ºåµŒå¥—é”®å®¹å™¨ï¼Œæ³¨æ„ç±»å‹ä¹Ÿæ˜¯é”®å®¹å™¨
            
            // The rest of the keys use static names defined in `ProductKey`.åœ¨åµŒå¥—çš„é”®å®¹å™¨å†…éƒ¨æ·»åŠ Productç±»å‹çš„å¦å¤–ä¸¤ä¸ªå±æ€§ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªå±æ€§æ˜¯åŸºæœ¬å±æ€§æ¥ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥encodeï¼Œç„¶åå¯¹åº”keyæ¥ä¿å­˜ã€‚è¿™é‡Œä¹Ÿéœ€è¦æ€è€ƒå¦‚æœä¸æ˜¯é”®å®¹å™¨ç±»å‹ï¼Œè€Œæ˜¯æ— é”®å®¹å™¨ï¼ˆä¹Ÿå°±æ˜¯jsoné‡Œé¢çš„æ•°ç»„ï¼‰ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•æ“ä½œå‘¢ï¼Ÿåº”è¯¥æ˜¯æœ‰å…¶ä»–çš„encodeæ–¹æ³•ï¼Ÿ
            try productContainer.encode(product.points, forKey: .points)
            try productContainer.encode(product.description, forKey: .description)
        }
    }
```
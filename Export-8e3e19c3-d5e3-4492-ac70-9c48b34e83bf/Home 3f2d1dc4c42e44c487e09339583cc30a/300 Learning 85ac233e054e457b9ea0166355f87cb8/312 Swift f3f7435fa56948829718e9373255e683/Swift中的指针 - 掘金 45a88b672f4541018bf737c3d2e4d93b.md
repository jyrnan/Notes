# Swiftä¸­çš„æŒ‡é’ˆ - æ˜é‡‘

# å¼•è¨€

ä¸€èˆ¬æ¥è¯´ï¼Œ`Swift`æ˜¯ä¸€é—¨éå¸¸å®‰å…¨çš„è¯­è¨€ï¼Œå¹³æ—¶åšä¸šåŠ¡çš„æ—¶å€™ï¼ŒåŸºæœ¬ä¸Šç”¨çš„ç»“æ„ä½“ï¼Œç±»ç­‰ï¼Œéƒ½ä¸ä¼šç›´æ¥æ“ä½œå†…å­˜ï¼Œè€Œä¸”æœ‰å¯é€‰å€¼çš„åŒ…è£…ï¼Œä¹Ÿä¿è¯äº†å€¼çš„å®‰å…¨ã€‚ä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›æ¯”è¾ƒç‰¹æ®Šçš„ä¸šåŠ¡éœ€è¦ç”¨åˆ°æŒ‡é’ˆï¼Œæ¯”å¦‚ä¸åº•å±‚Cçš„äº¤äº’ï¼Œå­—èŠ‚æµçš„è§£æç­‰ã€‚è¿™æ—¶å€™ï¼Œ`Swift`å°†ä¼šå˜å¾—æ²¡é‚£ä¹ˆå®‰å…¨ï¼Œéœ€è¦æˆ‘ä»¬å°å¿ƒç¿¼ç¿¼çš„æ“ä½œï¼Œå¹¶ä¸”éœ€è¦æ·±åˆ»ç†è§£`Swift`çš„æŒ‡é’ˆç±»å‹

# `MemoryLayout`

åœ¨è®²æŒ‡é’ˆä¹‹å‰ï¼Œå¿…é¡»å…ˆå¾—äº†è§£ä¸€ä¸‹`Swift`çš„å†…å­˜å¸ƒå±€`MemoryLayout`ï¼Œä¸åŒçš„åŸºç¡€ç±»å‹ã€ç»“æ„ä½“ã€æšä¸¾ã€ç±»ç­‰ç­‰ï¼Œä»–ä»¬åœ¨å†…å­˜ä¸­å æœ‰çš„å¤§å°ï¼Œæ­¥é•¿ï¼Œå¯¹é½é•¿åº¦éƒ½ä¸ä¸€æ ·ã€‚ä¸€æ—¦æŒ‡é’ˆçš„åç§»é‡ã€è·å–å€¼çš„é•¿åº¦é”™è¯¯ï¼Œè½»åˆ™è·å–çš„å€¼é”™è¯¯ï¼Œé‡åˆ™ç¨‹åºå´©æºƒã€‚

## åŸºç¡€ç±»å‹çš„`MemoryLayout`

```swift
MemoryLayout<Int>.size          // returns 8 (on 64-bit)
MemoryLayout<Int>.alignment     // returns 8 (on 64-bit)
MemoryLayout<Int>.stride        // returns 8 (on 64-bit)

MemoryLayout<Int16>.size        // returns 2
MemoryLayout<Int16>.alignment   // returns 2
MemoryLayout<Int16>.stride      // returns 2

MemoryLayout<Bool>.size         // returns 1
MemoryLayout<Bool>.alignment    // returns 1
MemoryLayout<Bool>.stride       // returns 1

MemoryLayout<Float>.size        // returns 4
MemoryLayout<Float>.alignment   // returns 4
MemoryLayout<Float>.stride      // returns 4

MemoryLayout<Double>.size       // returns 8
MemoryLayout<Double>.alignment  // returns 8
MemoryLayout<Double>.stride     // returns 8

...
å¤åˆ¶ä»£ç 
```

MemoryLayoutæ˜¯ä¸€ä¸ªåœ¨ç¼–è¯‘æ—¶è¯„ä¼°çš„æ³›å‹ç±»å‹ã€‚å®ƒç¡®å®šæ¯ä¸ªæŒ‡å®šç±»å‹çš„å¤§å°ã€å¯¹é½æ–¹å¼å’Œæ­¥é•¿ï¼Œå¹¶è¿”å›ä¸€ä¸ªä»¥å­—èŠ‚ä¸ºå•ä½çš„æ•°å­—ã€‚

æˆ‘ä»¬å¯ä»¥é å¦‚ä¸Šçš„æ–¹å¼è·å–æ•°æ®ç±»å‹çš„`MemoryLayout`ï¼š

- `size`ï¼šæ•°æ®ç±»å‹çš„é•¿åº¦ï¼Œå°±æ˜¯æ•°æ®åœ¨å†…å­˜ä¸­å æ®çš„å¤§å°
- `alignment`ï¼šæ•°æ®ç±»å‹çš„å¯¹é½æ–¹å¼ï¼Œåœ¨æŸäº›ç»“æ„ä¸­ï¼ˆæ¯”å¦‚åœ¨`Raw Pointer`ï¼‰ï¼Œæ•°æ®åœ¨å†…å­˜çš„é¦–åœ°å€å¿…é¡»æ˜¯`alignment`çš„å€æ•°ï¼Œå¦åˆ™å°†ä¼šå´©æºƒï¼Œä¾‹å¦‚`Int16`çš„`alignment`æ˜¯2ï¼Œé‚£ä¹ˆ`Int16`åœ¨å†…å­˜çš„é¦–åœ°å€å¿…é¡»æ˜¯å¶æ•°ï¼Œå¦åˆ™å¥”æºƒ
- `stride`ï¼šæ•°æ®ç±»å‹çš„æ­¥é•¿ï¼Œåº”è¯¥æ˜¯`alignment`çš„å€æ•°ï¼Œå¦‚æœæ˜¯ä¸€ä¸²ç´§æŒ¨çš„æ•°æ®ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªæ•°æ®ä¼šåœ¨å¤§äºç­‰äº`stride`çš„åœ°å€ä¹‹å

å…³äºæ•°æ®ç±»å‹çš„å¯¹é½æ–¹å¼ä¸¾ä¸ªä¾‹å­ï¼ŒDemoå¦‚ä¸‹ï¼š

```swift
//å‘å †ç”³è¯·å¼€è¾Ÿç©ºé—´
let p = UnsafeMutableRawPointer.allocate(byteCount: 4 * 8, alignment: 8)
//ç»“æŸæ—¶é‡Šæ”¾ç©ºé—´
defer {
    p.deallocate()
}
//åœ¨è¿™å—è¿ç»­çš„å†…å­˜ç©ºé—´å†…ï¼Œæ”¾ä¸Š0ï¼Œ1ï¼Œ2ï¼Œ3
for i in 0..<4 {
    p.advanced(by: i * 8).storeBytes(of: i, as: Int.self)
}
let offset = 8
print(p.advanced(by: offset).load(as: Int.self))
å¤åˆ¶ä»£ç 
```

`Int`çš„`alignment`ä¸º8ï¼Œå½“`offset`ä¸º8çš„å€æ•°æ—¶ï¼Œå¯ä»¥å–åˆ°å¯¹åº”çš„å€¼ï¼Œå³ä½¿è¶Šç•Œï¼Œä¹Ÿèƒ½å–åˆ°0æˆ–è€…å¥‡æ€ªçš„æ•°å­—ï¼Œä¸ä¼šå´©æºƒã€‚ä½†å¦‚æœ`offset`ä¸ä¸º8çš„å€æ•°æ—¶ï¼Œç¨‹åºç›´æ¥é£˜çº¢ï¼š

[Swift%E4%B8%AD%E7%9A%84%E6%8C%87%E9%92%88%20-%20%E6%8E%98%E9%87%91%2045a88b672f4541018bf737c3d2e4d93b/cd325b196766488599edf2e2d446ff6ctplv-k3u1fbpfcp-zoom-in-crop-mark4536000.awebp](Swift%E4%B8%AD%E7%9A%84%E6%8C%87%E9%92%88%20-%20%E6%8E%98%E9%87%91%2045a88b672f4541018bf737c3d2e4d93b/cd325b196766488599edf2e2d446ff6ctplv-k3u1fbpfcp-zoom-in-crop-mark4536000.awebp)

å°†ä¼šå‡ºç°ï¼š

> 
> 
> 
> Fatal error: load from misaligned raw pointer
> 

ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼š

> 
> 
> 
> è‡´å‘½é”™è¯¯:ä»æœªå¯¹é½çš„åŸå§‹æŒ‡é’ˆåŠ è½½
> 

## å…¶ä»–ç±»å‹çš„`MemoryLayout`

`Swift`ä¸­è¿˜æœ‰è®¸å¤šå…¶ä»–çš„ç±»å‹ï¼šç»“æ„ä½“ï¼Œæšä¸¾ï¼Œç±»ç­‰

æˆ‘ä»¬å¯ä»¥ç”¨åŒæ ·çš„æ–¹å¼æ¥æŸ¥çœ‹ä»–ä»¬çš„`MemoryLayout`

```swift
struct EmptyStruct {}

MemoryLayout<EmptyStruct>.size      // returns 0
MemoryLayout<EmptyStruct>.alignment // returns 1
MemoryLayout<EmptyStruct>.stride    // returns 1

struct SampleStruct {
  let number: UInt32
  let flag: Bool
}

MemoryLayout<SampleStruct>.size       // returns 5
MemoryLayout<SampleStruct>.alignment  // returns 4
MemoryLayout<SampleStruct>.stride     // returns 8

class EmptyClass {}

MemoryLayout<EmptyClass>.size      // returns 8 (on 64-bit)
MemoryLayout<EmptyClass>.stride    // returns 8 (on 64-bit)
MemoryLayout<EmptyClass>.alignment // returns 8 (on 64-bit)

class SampleClass {
  let number: Int64 = 0
  let flag = false
}

MemoryLayout<SampleClass>.size      // returns 8 (on 64-bit)
MemoryLayout<SampleClass>.stride    // returns 8 (on 64-bit)
MemoryLayout<SampleClass>.alignment // returns 8 (on 64-bit)
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬å¯ä»¥å‘ç°ï¼š

`EmptyStruct`ç©ºç»“æ„ä½“çš„å¤§å°ä¸ºé›¶ã€‚å¯¹é½å¤§å°æ˜¯1ï¼Œæ‰€æœ‰æ•°å­—éƒ½å¯ä»¥è¢«1æ•´é™¤ï¼Œæ‰€ä»¥å®ƒå¯ä»¥å­˜æ”¾äºä»»ä½•åœ°å€ã€‚æ­¥é•¿ä¹Ÿä¸º1ï¼Œè™½ç„¶å®ƒçš„å¤§å°ä¸ºé›¶ï¼Œä½†æ˜¯å¿…é¡»æœ‰ä¸€ä¸ªå”¯ä¸€çš„å†…å­˜åœ°å€ã€‚

`SampleStruct`çš„å¤§å°ä¸º5ï¼Œç­‰äº`UInt32`å’Œ`Bool`å¤§å°çš„ç›¸åŠ ã€‚å¯¹é½å¤§å°æ˜¯4ï¼Œç­‰äº`UInt32`çš„å¯¹é½å¤§å°ï¼Œå±æ€§ä¸­æœ€å¤§çš„å¯¹é½æ–¹å¼ä¼šå†³å®šç»“æ„ä½“çš„å¯¹é½æ–¹å¼ã€‚æ­¥é•¿ä¸º8ï¼Œæ¯”5å¤§çš„ï¼Œæœ€å°çš„4çš„å€æ•°ä¸º8ï¼Œæ‰€ä»¥æ­¥é•¿ä¸º8ã€‚

`EmptyClass`å’Œ`SampleClass`ï¼Œä¸ç®¡æ˜¯å¦åŒ…å«å±æ€§ï¼Œä»–ä»¬çš„å¤§å°ï¼Œå¯¹é½æ–¹å¼ï¼Œæ­¥é•¿éƒ½ä¸º8ï¼Œå› ä¸ºç±»æ˜¯å¼•ç”¨ç±»å‹ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œåœ¨64ä½çš„ç³»ç»Ÿä¸‹ï¼ŒæŒ‡é’ˆé•¿åº¦å°±æ˜¯ä¸º8.

å½“ç„¶ï¼Œè¿˜æœ‰æšä¸¾ã€æ•°ç»„ã€å­—å…¸ç­‰ç­‰çš„`MemoryLayout`ï¼Œä»¥åŠç»“æ„ä½“å±æ€§å†…éƒ¨é¡ºåºä¸ä¸€æ ·ï¼Œä¼šé€ æˆç»“æ„ä½“çš„å¤§å°ä¹Ÿä¸ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†è¯´æ˜äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±å®éªŒä¸‹ï¼Œæœ‰æ—¶é—´æˆ‘ä¼šå•ç‹¬å¼€ä¸€ç¯‡æ–‡ç« è¯¦è¿°ã€‚

# æŒ‡é’ˆç±»å‹

åœ¨`Swift`ä¸­ï¼Œå› ä¸ºæŒ‡é’ˆå¯ä»¥ç›´æ¥æ“ä½œå†…å­˜ï¼Œæ‰€ä»¥ç”¨ä¸Šäº†`Unsafe`çš„å¼€å¤´ä¿®é¥°ï¼Œè™½ç„¶æ¯æ¬¡ç”³æ˜æŒ‡é’ˆçš„æ—¶å€™ï¼Œè¦å¤šå†™è¿™ä¸ªä¿®é¥°è¯ï¼Œä½†æ˜¯å¯ä»¥æ—¶åˆ»æé†’ç€ä½ åœ¨è®¿é—®ç¼–è¯‘å™¨æ²¡æœ‰æ£€æŸ¥çš„å†…å­˜ï¼Œå¦‚æœæ“ä½œä¸å½“ï¼Œä½ ä¼šé‡åˆ°ä¸€äº›å¥‡æ€ªçš„é—®é¢˜ï¼Œç”šè‡³å¥”æºƒã€‚

`Swift`ä¸åƒ`C`çš„`char *`é‚£æ ·åªæä¾›ä¸€ç§éç»“æ„åŒ–æ–¹å¼è®¿é—®å†…å­˜çš„éå®‰å…¨æŒ‡é’ˆç±»å‹ã€‚SwiftåŒ…å«è¿‘12ç§æŒ‡é’ˆç±»å‹ï¼Œæ¯ç§ç±»å‹éƒ½æœ‰ä¸åŒçš„åŠŸèƒ½å’Œç”¨é€”ã€‚

æˆ‘ä»¬çœ‹ä¸‹å¸¸ç”¨çš„8ä¸ªæŒ‡é’ˆç±»å‹ï¼š

| æŒ‡é’ˆç±»å‹ | Editable | Collection | Strideable | Typed |
| --- | --- | --- | --- | --- |
| UnsafeMutablePointer<T> | YES | NO | YES | YES |
| UnsafePointer<T> | NO | NO | YES | YES |
| UnsafeMutableBufferPointer<T> | YES | YES | NO | YES |
| UnsafeBufferPointer<T> | NO | YES | NO | YES |
| UnsafeMutableRawPointer | YES | NO | YES | NO |
| UnsafeRawPointer | NO | NO | YES | NO |
| UnsafeMutableRawBufferPointer | YES | YES | NO | NO |
| UnsafeRawBufferPointer | NO | YES | NO | NO |
|  |  |  |  |  |
- `Editable`: ç±»å‹åä¸­å¸¦æœ‰`Mutable`çš„ï¼Œè¯´æ˜éƒ½æ˜¯å¯ä»¥å†™å…¥æ›´æ”¹æ•°æ®çš„ï¼Œå…¶ä½™çš„åªèƒ½è¯»å–ï¼Œå¹¶ä¸èƒ½ä¿®æ”¹ï¼Œå¯ä»¥ä¿æŠ¤æ•°æ®å®‰å…¨ã€‚æ ¹æ®è‡ªå·±çš„éœ€æ±‚çœ‹ï¼Œæ˜¯å¦éœ€è¦`Mutable`
- `Collection`: ç±»å‹åä¸­å¸¦æœ‰`Buffer`çš„ï¼Œéƒ½å…·æœ‰`Collection`çš„ç‰¹æ€§ï¼Œå¦‚æœæŸ¥çœ‹ä»–ä»¬çš„å£°æ˜æ–‡ä»¶ï¼Œå‘ç°ä»–ä»¬éƒ½éµå®ˆ`Collection`åè®®
- `Strideable`: ä¸å¸¦æœ‰`Buffer`çš„å¯ä»¥è°ƒç”¨`advanced`æ–¹æ³•ï¼Œ`Typed`ç±»å‹çš„é»˜è®¤æ­¥é•¿ä¸º`T`çš„æ­¥é•¿ï¼Œè€Œ`Raw`ç±»å‹çš„é»˜è®¤æ­¥é•¿ä¸º1
- `Typed`: æœ‰èŒƒå‹çš„æ˜¯`Typed Pointer`ï¼Œå¸¦æœ‰`Raw`å­—æ®µçš„æ˜¯`Raw Pointer`

ä¸åŒçš„ç±»å‹ä¼šç”¨åœ¨ä¸åŒçš„åœºæ™¯ï¼Œçœ‹æƒ…å†µä½¿ç”¨ï¼Œæˆ–è€…ç›¸äº’è½¬æ¢

# æŒ‡é’ˆçš„æ“ä½œ

æˆ‘ä»¬å¯ä»¥åœ¨å †ä¸Šå¼€è¾Ÿä¸€å—ç©ºé—´ï¼Œç„¶åç”¨æŒ‡é’ˆæŒ‡å‘å®ƒã€‚åœ¨è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•çš„æ—¶å€™ï¼ŒæŒ‡é’ˆå¿…é¡»æ˜¯`Mutable`ç±»å‹çš„ï¼Œä¸ç„¶æ²¡æœ‰æ„ä¹‰ã€‚è€Œä¸”æŒ‡é’ˆæ˜¯`Unsafe`çš„ï¼Œç¼–è¯‘å™¨ä¸ä¼šå‚ä¸è¯¥æŒ‡é’ˆçš„ç”Ÿå‘½å‘¨æœŸï¼Œæ‰€ä»¥ï¼Œè‡ªå·±åœ¨å †ä¸Šç”³è¯·ç©ºé—´åï¼Œç»“æŸä½¿ç”¨æ—¶å¿…é¡»è¦è‡ªå·±é‡Šæ”¾ï¼Œä¸ç„¶ä¼šå†…å­˜æ³„éœ²ã€‚

## `Unsafe Pointer`åˆå§‹åŒ–

```swift

//åƒå †å†…å­˜ç”³è¯·å¼€è¾Ÿç©ºé—´
var mutableRawPointer = UnsafeMutableRawPointer.allocate(byteCount: byteCount, alignment: alignment)
//ä½œç”¨åŸŸç»“æŸæ—¶æ‰§è¡Œ
defer {
    //é‡Šæ”¾å¼€è¾Ÿçš„ç©ºé—´
    mutableRawPointer.deallocate()
}

var mutableTypedPointer = UnsafeMutablePointer<Int>.allocate(capacity: count)
mutableTypedPointer.initialize(repeating: 0, count: count)
defer {
    mutableTypedPointer.deinitialize(count: count)
    mutableTypedPointer.deallocate()
}

var mutableRawBufferPointer = UnsafeMutableRawBufferPointer.allocate(byteCount: byteCount, alignment: alignment)
defer {
    mutableRawBufferPointer.deallocate()
}

var mutableTypedBufferPointer = UnsafeMutableBufferPointer<Int>.allocate(capacity: count)
mutableTypedBufferPointer.initialize(repeating: 0)
defer {
    mutableTypedBufferPointer.deallocate()
}
å¤åˆ¶ä»£ç 
```

## `Unsafe Pointer`èµ‹å€¼ä¸å–å€¼æ“ä½œ

<aside>
ğŸ’¡ raw: `storeBytes` `load` allocate

- typed: å¯¹`pointee`è¿›è¡Œè¯»å†™
- bufferï¼šæŒ‰ç…§æ•°ç»„æ“ä½œï¼Œå¦‚æœæ˜¯rawBufferå°±æ˜¯UInt8ï¼Œå¦‚æœæ˜¯typedBufferå°±æ˜¯å…·ä½“çš„Tç±»å‹
</aside>

```swift
//mutableRawPointerçš„å­˜å€¼ä¸å–å€¼ï¼ŒmutableRawPointeré»˜è®¤æ­¥é•¿ä¸º1
(mutableRawPointer + 2 * alignment).storeBytes(of: 23, as: Int.self)
print(mutableRawPointer.advanced(by: 2 * alignment).load(as: Int.self))

mutableRawPointer.storeBytes(of: 33, toByteOffset: 2 * alignment, as: Int.self)
print(mutableRawPointer.load(fromByteOffset: 2 * alignment, as: Int.self))

//mutableTypedPointerçš„å­˜å€¼ä¸å–å€¼ï¼ŒmutableRawPointeré»˜è®¤æ­¥é•¿ä¸ºIntçš„æ­¥é•¿
mutableTypedPointer.advanced(by: 2).**pointee** = 27
print(mutableTypedPointer[2])

(mutableTypedPointer + 2).pointee = 37
print(mutableTypedPointer.successor().successor().pointee)

//mutableRawBufferPointerçš„å­˜å€¼ä¸å–å€¼ï¼Œå¯ä»¥åƒæ•°ç»„ä¸€æ ·å–å•ä¸ªå…ƒç´ ï¼Œä¸è¿‡æ˜¯UInt8çš„
mutableRawBufferPointer.storeBytes(of: 13, toByteOffset: 2 * alignment, as: Int.self)
print(mutableRawBufferPointer.load(fromByteOffset: 2 * alignment, as: Int.self))
//å‘ç°å†…å­˜ä¸­æœ‰åƒåœ¾å€¼ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°åˆå§‹åŒ–æˆ0çš„ä¾¿åˆ©æ–¹æ³•ï¼Œå¥½å¥‡æ€ª
for (index, value) in mutableRawBufferPointer.enumerated() {
    print("value \(index): \(value)")
}

//mutableTypedBufferPointerçš„å­˜å€¼ä¸å–å€¼ï¼Œå’ŒmutableRawBufferPointerçœ‹æˆä¸€ä¸ªæ•°ç»„ï¼Œä¸è¿‡mutableRawBufferPointeræ˜¯[UInt8]ï¼Œè€ŒmutableTypedBufferPointeræ˜¯[Int]
mutableTypedBufferPointer[2] = 9
print(mutableTypedBufferPointer[2])
for (index, value) in mutableTypedBufferPointer.enumerated() {
    print("value \(index): \(value)")
}
å¤åˆ¶ä»£ç 
```

## åŒç±»å‹mutableäº’è½¬

<aside>
ğŸ’¡ mutableè½¬unMutableç›´æ¥è½¬

- unMutableè½¬mutableç”¨mutaiingå‚æ•°
</aside>

```swift
var rawPointer = UnsafeRawPointer(mutableRawPointer)
var typedPointer = UnsafePointer(mutableTypedPointer)
var rawBufferPointer = UnsafeRawBufferPointer(mutableRawBufferPointer)
var typedBufferPointer = UnsafeBufferPointer(mutableTypedBufferPointer)

mutableRawPointer = UnsafeMutableRawPointer(mutating: rawPointer)
mutableTypedPointer = UnsafeMutablePointer(mutating: typedPointer)
mutableRawBufferPointer = UnsafeMutableRawBufferPointer(mutating: rawBufferPointer)
mutableTypedBufferPointer = UnsafeMutableBufferPointer(mutating: typedBufferPointer)
å¤åˆ¶ä»£ç 
```

åœ¨OCä¸­çš„å¯å˜åˆ°ä¸å¯å˜ï¼Œå¾€å¾€æ„å‘³ç€æ·±æ‹·è´ã€‚é‚£ä¹ˆåœ¨è¿™é‡Œçš„æŒ‡é’ˆä¼šä¸ä¼šæ‹·è´ä¸€ä»½å†…å®¹åˆ°æ–°çš„æŒ‡é’ˆä¹ˆï¼Ÿ

æˆ‘ä»¬å¯ä»¥æ‰“å°ä¸‹ä»–ä»¬çš„åœ°å€ï¼š

æˆ‘ä»¬å¯ä»¥å¾ˆæ˜æ˜¾çœ‹åˆ°ï¼Œä»–ä»¬çš„åœ°å€å®Œå…¨æ²¡å˜ï¼Œæ¢å¥è¯è¯´ï¼Œä»–ä»¬éƒ½æŒ‡å‘åŒä¸€ç‰‡å†…å­˜åœ°å€ã€‚æ‰€ä»¥`mutable`è¿™ä¸ªä¿®é¥°è¯åªæ˜¯åœ¨APIå±‚é¢é™åˆ¶ä½ èƒ½ä¸èƒ½ä¿®æ”¹å†…å­˜è€Œå·²ã€‚

## ä¸åŒç±»å‹çš„æŒ‡é’ˆç›¸äº’è½¬åŒ–

<aside>
ğŸ’¡ Typedè½¬Rawç›´æ¥è½¬

- Bufferè½¬éBufferéœ€è¦**baseAddress**
- è½¬Typed éœ€è¦ç”¨åˆ°`bindMemory`æ¥ç»‘å®šç±»å‹ï¼Œæˆ–è€… `assumingMemoryBound` æ¥ç¡®å®šå†…å­˜è¾¹ç•Œ
- è½¬TypedBufferæœ€å¤æ‚ï¼Œéœ€è¦æŒ‡å®šç±»å‹ï¼Œéœ€è¦æŒ‡å®šæ•°é‡
</aside>

```swift
/**
 è¿™å—è½¬åŒ–ä¼šå¼•èµ·ä¸Šæ–¹deferä¸­é‡Šæ”¾çš„å´©æºƒï¼Œå› ä¸ºå¯¹è±¡å˜äº†ï¼ŒåŒä¸€å—ç©ºé—´å¤šæ¬¡é‡Šæ”¾äº†ï¼Œè¿™è¾¹åªæ˜¯ç¤ºèŒƒè½¬åŒ–ï¼ŒçœŸçš„è¦è¿è¡Œç¨‹åºï¼Œè¯·æ³¨é‡Šè¿™å—
 */

//å…¶ä»–ç±»å‹è½¬mutableRawPointer
mutableRawPointer = UnsafeMutableRawPointer(mutableTypedPointer)

//å¦‚æœä½ èƒ½ä¿è¯countä¸ä¸º0ï¼Œå¯ä»¥å¼ºè½¬ã€‚ä½†æ˜¯å¦‚æœbaseAddressæœ‰å€¼ï¼Œä¸ä¸€å®šcountå¤§äº0ã€‚åœ¨åº•å±‚ï¼ŒUnsafePointer<T> å’Œ Optional<UnsafePointer<T> çš„å†…å­˜ç»“æ„å®Œå…¨ç›¸åŒï¼›ç¼–è¯‘å™¨ä¼šå°† Optional.none æ˜ å°„ä¸ºä¸€ä¸ªæ‰€æœ‰ä½å…¨ä¸ºé›¶çš„ç©ºæŒ‡é’ˆã€‚
mutableRawPointer = mutableRawBufferPointer.**baseAddress**!
mutableRawPointer = UnsafeMutableRawPointer(mutableTypedBufferPointer.baseAddress!)

//å…¶ä»–ç±»å‹è½¬mutableTypedPointer
mutableTypedPointer = mutableRawPointer.bindMemory(to: Int.self, capacity: count)
mutableTypedPointer = mutableRawPointer.assumingMemoryBound(to: Int.self)
mutableTypedPointer = mutableRawBufferPointer.baseAddress!.assumingMemoryBound(to: Int.self)
mutableTypedPointer = mutableTypedBufferPointer.baseAddress!

//å…¶ä»–ç±»å‹è½¬mutableRawBufferPointer
mutableRawBufferPointer = UnsafeMutableRawBufferPointer.init(start: mutableRawPointer, count: byteCount)
mutableRawBufferPointer = UnsafeMutableRawBufferPointer.init(start: UnsafeMutableRawPointer(mutableTypedPointer), count: byteCount)
mutableRawBufferPointer = UnsafeMutableRawBufferPointer(mutableTypedBufferPointer)

//å…¶ä»–ç±»å‹è½¬mutableTypedBufferPointer
mutableTypedBufferPointer = UnsafeMutableBufferPointer.init(start: mutableRawPointer.assumingMemoryBound(to: Int.self), count: count)
mutableTypedBufferPointer = UnsafeMutableBufferPointer.init(start: mutableTypedPointer, count: count)
mutableTypedBufferPointer = mutableRawBufferPointer.bindMemory(to: Int.self)
mutableTypedBufferPointer = UnsafeMutableBufferPointer.init(start: mutableRawBufferPointer.baseAddress?.assumingMemoryBound(to: Int.self), count: mutableRawBufferPointer.count/MemoryLayout<Int>.stride)

//ç»ˆæè½¬åŒ–æ–¹æ³•ï¼ˆbufferä¸å»ºè®®ç”¨ï¼Œè‡³å°‘countå°±ä¸ä¸€æ ·ï¼‰ï¼Œæ¯”è¾ƒå±é™©ï¼Œé™¤éç¡®ä¿æ­£ç¡®ï¼Œç±»çš„å¼•ç”¨ä¹Ÿå¯ä»¥é è¿™ä¸ªå˜æˆæŒ‡é’ˆ
mutableRawPointer = unsafeBitCast(mutableTypedPointer, to: UnsafeMutableRawPointer.self)
mutableTypedPointer = unsafeBitCast(mutableRawPointer, to: UnsafeMutablePointer<Int>.self)
å¤åˆ¶ä»£ç 
```

è¿™è¾¹çš„è½¬åŒ–æ–¹æ³•åº”è¯¥ä¸å…¨ï¼Œå¦‚æœå¥½çš„æ–¹æ³•é—æ¼çš„ï¼Œæ¬¢è¿è¯„è®ºåŒºè¡¥å……ã€‚

# `bindMemory`å’Œ`assumingMemoryBound`çš„åŒºåˆ«

å…ˆè´´ä¸‹å®˜æ–¹æ³¨é‡Š `bindMemory`:

> 
> 
> 
> Binds the memory to the specified type and returns a typed pointer to the bound memory.
> 
> Use the `bindMemory(to:capacity:)` method to bind the memory referenced by this pointer to the type `T`. The memory must be uninitialized or initialized to a type that is layout compatible with `T`. If the memory is uninitialized, it is still uninitialized after being bound to `T`.
> 

`assumingMemoryBound`:

> 
> 
> 
> Returns a typed pointer to the memory referenced by this pointer, assuming that the memory is already bound to the specified type.
> 
> Use this method when you have a raw pointer to memory that has *already* been bound to the specified type. The memory starting at this pointer must be bound to the type `T`. Accessing memory through the returned pointer is undefined if the memory has not been bound to `T`. To bind memory to `T`, use `bindMemory(to:capacity:)` instead of this method.
> 

è¿™é‡Œå…ˆè¯´ä¸‹å‡ ä¸ªçŠ¶æ€

- `Uninitialised raw memory`: æœªåˆå§‹åŒ–çš„åŸå§‹å†…å­˜
- `Uninitialised memory that's bound to a type`: ç»‘å®šåˆ°ç±»å‹çš„æœªåˆå§‹åŒ–å†…å­˜
- `Initialised memory bound to a type`: ç»‘å®šåˆ°ç±»å‹çš„åˆå§‹åŒ–å†…å­˜

å½“ä½ ä½¿ç”¨`UnsafeMutableRawPointer.allocate(bytes:alignment:)`åˆ†é…å†…å­˜æ—¶ï¼Œä½ å¾—åˆ°çš„æ˜¯æœªåˆå§‹åŒ–çš„åŸå§‹å†…å­˜ã€‚

å½“ä½ ä½¿ç”¨`UnsafeMutablePointer<T>.allocate(capacity:)`åˆ†é…å†…å­˜æ—¶ï¼Œä½ ä¼šå¾—åˆ°ç»‘å®šåˆ°ç±»å‹`T`çš„æœªåˆå§‹åŒ–å†…å­˜ã€‚

å½“ä½ ä½¿ç”¨ä¸Šè¿°æŒ‡é’ˆè°ƒç”¨`initialize`ç³»åˆ—æ–¹æ³•å¯ä»¥å¾—åˆ°ç»‘å®šåˆ°ç±»å‹`T`çš„åˆå§‹åŒ–å†…å­˜

å¦‚æœæŒ‡é’ˆçš„`Pointee`ç±»å‹ (ä¹Ÿå°±æ˜¯æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®ç±»å‹) æ˜¯ä¸€ä¸ªéœ€è¦å†…å­˜ç®¡ç†çš„éç®€å•ç±»å‹ (ä¾‹å¦‚åœ¨ä¸€ä¸ªç±»æˆ–ç»“æ„ä½“ä¸­åŒ…å«äº†å…¶å®ƒç±»)ï¼Œä½ å¿…é¡»åœ¨è°ƒç”¨`deallocate`ä¹‹å‰è°ƒç”¨`deinitialize`ã€‚`initialize`å’Œ`deinitialize`æ–¹æ³•ç”¨äºç®¡ç†`ARC`ä¸­çš„å¼•ç”¨è®¡æ•°ã€‚å¿˜è®°è°ƒç”¨`deinitialize` å¯èƒ½ä¼šå¼•èµ·å†…å­˜æ³„æ¼ã€‚æ›´ç³Ÿçš„æ˜¯ï¼Œå¦‚æœå¿˜è®°è°ƒç”¨`initialize`ï¼Œä¾‹å¦‚ç›´æ¥ç”¨ä¸‹æ ‡æ“ä½œç¬¦ç»™æŒ‡å‘ä¸€ç‰‡æœªåˆå§‹åŒ–å†…å­˜çš„æŒ‡é’ˆèµ‹å€¼ï¼Œå¯ä»¥å¼•å‘å„ç§æœªå®šä¹‰çš„é—®é¢˜ç”šè‡³è®©ç¨‹åºå´©æºƒã€‚

å¦‚æœæŒ‡é’ˆçš„`Pointee`ç±»å‹æ˜¯ä¸€ä¸ªç®€å•ç±»å‹ï¼ˆä¾‹å¦‚ç»“æ„ä½“ï¼Œæšä¸¾ç­‰ï¼‰ï¼Œå¯ä»¥æ¸…é™¤å†…å­˜ä¸­çš„åƒåœ¾å€¼ï¼Œä»¥å…å¼•èµ·ä¸å¯é¢„æ–™çš„é”™è¯¯ï¼Œè¿™ä¸ªå’Œ`C`åˆå§‹åŒ–å†…å­˜å¾ˆåƒã€‚

æˆ‘ä»¬çœ‹äº†å®˜æ–¹çš„è§£é‡Šï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºï¼š

- å¦‚æœä½ çš„è¿™å—å†…å­˜æ˜¯æœªåˆå§‹åŒ–çš„åŸå§‹å†…å­˜ï¼Œè°ƒç”¨`bindMemory`åï¼Œå°†ä¼šå¾—åˆ°ç»‘å®šåˆ°ç±»å‹çš„æœªåˆå§‹åŒ–å†…å­˜
- å¦‚æœä½ çš„è¿™å—å†…å­˜æ˜¯ç»‘å®šåˆ°ç±»å‹çš„åˆå§‹åŒ–å†…å­˜ï¼Œä½†ä½ æƒ³è¦ç»‘å®šçš„ç±»å‹å’Œå·²ç»‘å®šçš„ç±»å‹çš„å¸ƒå±€å…¼å®¹ï¼Œé‚£ä¹ˆè°ƒç”¨`bindMemory`åï¼Œå°†ä¼šå¾—åˆ°æ–°ç»‘å®šåˆ°ç±»å‹çš„åˆå§‹åŒ–å†…å­˜
- `bindMemory`åªèƒ½ä¸Šè¿°ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨ï¼Œå…¶ä»–æƒ…å†µå¯ä»¥è°ƒç”¨`assumingMemoryBound`ï¼ˆåŒ…æ‹¬ä¸Šè¿°çš„ä¸¤ç§æƒ…å†µä¹Ÿå¯ä»¥è°ƒç”¨ï¼Œä¸è¿‡åœ¨è¿”å›æœªåˆå§‹åŒ–çš„åŸå§‹å†…å­˜æ—¶ï¼Œä¼šå‡ºç°æœªå®šä¹‰çš„æŒ‡é’ˆï¼Œ= =ä¸æ‡‚å•¥æ„æ€ï¼Œå“ˆå“ˆï¼Œè¯„è®ºåŒºè¯·æŒ‡æ•™ï¼‰ã€‚

è¿™é‡ŒåŒºåˆ†ä¸‹ç›¸å…³ç±»å‹å’Œå¸ƒå±€å…¼å®¹ç±»å‹æ˜¯ç‹¬ç«‹çš„æ¦‚å¿µ:

- å¸ƒå±€å…¼å®¹ï¼šå¦‚æœç»‘å®šåˆ°ç±»å‹`U`çš„å†…å­˜å¯ä»¥æŒ‰ä½é‡æ–°è§£é‡Šä¸ºå…·æœ‰ç±»å‹`T`ï¼Œåˆ™ç±»å‹`T`åœ¨å¸ƒå±€ä¸Šä¸ç±»å‹`U`å…¼å®¹ã€‚æ³¨æ„ï¼Œè¿™å¹¶ä¸ä¸€å®šæ˜¯ä¸€ç§åŒå‘å…³ç³»ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè®²å…ƒç¥–`(Int, Int)`çš„ä¸€ä¸ª'å®ä¾‹'å¯ä»¥è¢«é‡æ–°è§£é‡Šä¸º2*`Int`ï¼Œåˆ™`Int`ä¸`(Int, Int)`å¸ƒå±€å…¼å®¹ã€‚ä½†ä½ ä¸èƒ½ç”¨ä¸€ä¸ª`Int`æ¥æ„æˆä¸€ä¸ª`(Int, Int)`å€¼ã€‚
- ç›¸å…³ç±»å‹ï¼šå¦‚æœå¯ä»¥ç”¨è¿™ä¸¤ç§ç±»å‹ä¸ºé‡å å†…å­˜åˆ«åï¼Œé‚£ä¹ˆè¿™ä¸¤ç§ç±»å‹æ˜¯ç›¸å…³çš„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªUnsafePointerå’Œä¸€ä¸ªUnsafePointerï¼Œå¦‚æœTå’ŒUæ˜¯ä¸ç›¸å…³çš„ç±»å‹ï¼Œé‚£ä¹ˆå®ƒä»¬å°±ä¸èƒ½æŒ‡å‘å½¼æ­¤é‡å çš„å†…å­˜ã€‚

æˆ‘ä»¬çœ‹ä¸‹æºç çš„åŒºåˆ«

```swift

@_transparent
@discardableResult
public func bindMemory<T>(
    to type: T.Type, capacity count: Int
) -> UnsafePointer<T> {
    Builtin.bindMemory(_rawValue, count._builtinWordValue, type)
    return UnsafePointer<T>(_rawValue)
}

@_transparent
public func assumingMemoryBound<T>(to: T.Type) -> UnsafePointer<T> {
    return UnsafePointer<T>(_rawValue)
}
å¤åˆ¶ä»£ç 
```

- `@_transparent`ï¼šå’Œ`@inline(__always)`éå¸¸ç±»ä¼¼ï¼Œå¯ä»¥ç†è§£æˆå†…è”å‡½æ•°ï¼Œç¼–è¯‘çš„æ—¶å€™ï¼Œç›´æ¥å°†å‡½æ•°ä½“æ‹·è´åˆ°è°ƒç”¨çš„åœ°æ–¹ï¼Œæœ‰ç‚¹åƒå®å®šä¹‰ï¼Œè¿™æ ·ä¸ç”¨å¼€è¾Ÿæ–°çš„æ ˆï¼Œæ•ˆç‡æé«˜äº†ã€‚
- `@discardableResult`ï¼šé¡¾åæ€ä¹‰ï¼Œå‡½æ•°çš„è¿”å›ç»“æœå¯ä»¥ä¸ä½¿ç”¨ã€‚å¦‚æœä¸åŠ è¿™ä¸ªå…³é”®è¯ï¼Œé‚£ä¹ˆä½ ä¸ä½¿ç”¨è¯¥è¿”å›å€¼æ—¶ï¼Œç¼–è¯‘å™¨ä¼šé£˜é»„æé†’ã€‚
- `Builtin`ï¼šæ˜¯å†…ç½®å‘½ä»¤ï¼Œå¯ä»¥å…ˆäº†è§£ä¸‹`Swift`çš„[ç¼–è¯‘è¿‡ç¨‹](https://juejin.cn/post/6904994620628074510)ï¼Œ`Builtin`å°†`LLVM IR`çš„ç±»å‹å’Œæ–¹æ³•ç›´æ¥æš´éœ²ç»™`Swift`æ ‡å‡†åº“ï¼Œ`Builtin`æ¨¡å—åªæœ‰åœ¨æ ‡å‡†åº“å†…éƒ¨æ‰å¯ä»¥è®¿é—®ã€‚

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°`bindMemory`æ¯”`assumingMemoryBound`åªå¤šäº†è°ƒç”¨ä¸€ä¸ª`Builtin.bindMemory(_rawValue, count._builtinWordValue, type)`ï¼ŒçŒœæµ‹åº•å±‚åšäº†æŸäº›æ“ä½œï¼ˆä¹Ÿè®¸æ²¡æœ‰å“ˆï¼‰ï¼Œä¸‹æ¬¡æœ‰æœºä¼šåˆ†æ`LLVM`æºç ï¼Œè¿™å—è¡¥ä¸Šã€‚`bindMemory`æœ‰ä¸ª`@discardableResult`è¯ä¿®é¥°ï¼Œè¯´æ˜è¿™ä¸ªæ–¹æ³•æ›´å€¾å‘äºç»‘å®šç±»å‹ï¼Œå¹¶ä¸å…³æ³¨ç»“æœï¼Œåªæ˜¯é¡ºå¸¦è¿”å›ç»™ä½ ã€‚è€Œ`assumingMemoryBound`çœŸçš„åªæ˜¯ä»`API`å±‚é¢å°†ä¸€æ®µå†…å­˜ç©ºé—´ï¼Œå˜æˆä½ æƒ³ç»‘å®šçš„ç±»å‹æ“ä½œã€‚ä¸ªäººæ¨èï¼Œé™¤éä½ çœŸæ­£æƒ³ç»‘å®šå†…å­˜ç±»å‹ï¼Œå¦åˆ™è¿˜æ˜¯`assumingMemoryBound`ç”¨çš„æƒ…å†µå¤šä¸€ç‚¹ã€‚

ä¸è¿‡ä¸ªäººç›®å‰æµ‹ä¸‹æ¥ï¼Œä¸¤è€…æ–¹æ³•æš‚æ—¶æ²¡æœ‰åŒºåˆ«ã€‚ã€‚ã€‚å¦‚æœå¤§ä½¬æœ‰çŸ¥é“çš„ï¼Œè¯·å‘ŠçŸ¥ã€‚æˆ‘æŸ¥åˆ°èµ„æ–™åœ¨`Swift3`ä¸­çš„ç¡®æ˜¯æ²¡æœ‰åŒºåˆ«çš„ï¼Œå½“æ—¶å¯èƒ½æ˜¯ABIç¨³å®šçš„é—®é¢˜ï¼Œç°åœ¨å°±ä¸çŸ¥é“äº†ã€‚ä¸è¿‡è¿˜æ˜¯å»ºè®®å¬ä»å®˜æ–¹çš„ä½¿ç”¨æ–¹æ³•ï¼Œè°çŸ¥é“ä»¥åä¼šæ€ä¹ˆæ ·å‘¢ï¼Œä¹Ÿè®¸æ›´æ–°åå°±æ”¹äº†å‘¢ï¼Œæ˜¯å§ã€‚

# `Swift`ä¸­çš„å¸¸è§ç±»å‹è½¬æŒ‡é’ˆ

### ç»“æ„ä½“

ç»“æ„ä½“æ˜¯`Swift`çš„åŸºç¡€ç±»å‹ï¼Œåƒ`Int`ã€`Double`ã€`Bool`ç­‰ï¼Œéƒ½æ˜¯ç»“æ„ä½“ã€‚ä¸‹é¢ä¸¾ä¸ªåˆ—å­:

```swift
struct Teacher {
    var age = 12
    var name = "Tom"
}

var tc = Teacher.init()
withUnsafePointer(to: &tc) { pointer in
    // let pointer: UnsafePointer<Teacher>
    print("name: \(pointer.pointee.name), age: \(pointer.pointee.age)")
    // name: Tom, age: 12
}

// å¯ä»¥ä¸åŠ å–åœ°å€ç¬¦å·ï¼Œæ•ˆæœä¸€æ ·
withUnsafeMutablePointer(to: tc) { pointer in
    // let pointer: UnsafeMutablePointer<Teacher>
    pointer.pointee.age = 15
    pointer.pointee.name = "Harry"
    print("name: \(pointer.pointee.name), age: \(pointer.pointee.age)")
    // name: Harry, age: 15
}

withUnsafeBytes(of: &tc) { pointer in
    // let pointer: UnsafeRawBufferPointer
    print("data count: \(pointer.count)")
    // data count: 24
    print("name: \(pointer.load(as: Int.self)), age: \(pointer.load(fromByteOffset: MemoryLayout<Int>.stride, as: String.self))")
    // name: 15, age: Harry  å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„å€¼è¢«ä¸Šé¢å·²ç»æ”¹æ‰äº†ï¼Œå°è¯æ“ä½œçš„åŒä¸€ç‰‡å†…å­˜ç©ºé—´
}

withUnsafeMutableBytes(of: &tc) { pointer in
    // let pointer: UnsafeMutableRawBufferPointer
    pointer.storeBytes(of: 18, as: Int.self)
    pointer.storeBytes(of: "Marry", toByteOffset: MemoryLayout<Int>.stride, as: String.self) //è¿™ä¸ªå†™å…¥æŠ¥é”™ï¼ŒåŸå› æœªçŸ¥ã€‚ğŸ˜®â€ğŸ’¨
    print("data count: \(pointer.count)")
    // data count: 24
    print("name: \(pointer.load(as: Int.self)), age: \(pointer.load(fromByteOffset: MemoryLayout<Int>.stride, as: String.self))")
    // name: 18, age: Marry
}
å¤åˆ¶ä»£ç 
```

ç³»ç»Ÿæä¾›äº†4ç§æ–¹æ³•è·å–å€¼ç±»å‹çš„æŒ‡é’ˆï¼Œæ ¹æ®è‡ªå·±éœ€è¦ï¼Œé€‰æ‹©åˆé€‚çš„æ–¹æ³•ï¼Œå¦‚æœä½ ä¸æƒ³æ”¹å˜å®ä¾‹çš„å€¼ï¼Œå»ºè®®ä¸è¦ä½¿ç”¨`mutable`çš„æ–¹æ³•

### ç±»æŒ‡é’ˆ

ç±»æ˜¯å¼•ç”¨ç±»å‹ï¼Œæœ¬èº«æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥è½¬æˆä¸€ä¸ª`UnsafeRawPointer`æŒ‡é’ˆï¼Œä½†æˆ‘ä»¬åˆ†æè¿‡[ç±»çš„ç»“æ„](https://juejin.cn/post/6905708198796361736)ï¼Œé‚£æˆ‘ä»¬å¯ä»¥å£°æ˜ä¸€ä¸ªå¤§è‡´çš„ç»“æ„ä½“`HeapObject`ï¼Œå°†ç±»è½¬æˆ`UnsafePointer<HeapObject>`ç±»å‹ï¼Œä¸‹é¢çœ‹ä¸‹Demoï¼š

```swift
struct HeapObject {
    var kind: Int
    var unownedRef: UInt32
    var strongref: UInt32
}

class Teacher {
    var age = 18
}

var t = Teacher()
// æˆ‘ä»¬å¯ä»¥ä¸æ–­å£°æ˜å˜é‡ä½¿strongrefå¢åŠ 
var t1 = t

do { // å¯ä»¥ä½¿ç”¨Unmanagedè·å–æŒ‡é’ˆï¼Œlet ptr: UnsafeMutableRawPointer
    let ptr = Unmanaged.passUnretained(t).toOpaque()
    print(ptr.assumingMemoryBound(to: HeapObject.self).pointee)
    // HeapObject(kind: 4295000432, unownedRef: 3, strongref: 2)
}

do { // ç›´æ¥å¼ºè½¬ï¼Œå› ä¸ºæˆ‘ä»¬ç¡®å®šç»“æ„æ˜¯ä¸€è‡´çš„
    let ptr = unsafeBitCast(t, to: UnsafePointer<HeapObject>.self)
    print(ptr.pointee)
    // HeapObject(kind: 4295000432, unownedRef: 3, strongref: 2)
}
å¤åˆ¶ä»£ç 
```

ä¸èƒ½ä½¿ç”¨`withUnsafePointer`æ–¹æ³•è·å–ç±»çš„æŒ‡å‘ï¼Œå› ä¸ºä½ ä¸ç®¡ç”¨ä¸ç”¨å–åœ°å€ç¬¦ï¼Œéƒ½æ‹¿åˆ°çš„æ˜¯æŒ‡é’ˆçš„æŒ‡é’ˆï¼ˆå¤šæ€æ–¹æ³•åšå¤„ç†äº†ï¼‰ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚æ‰€ä»¥å¯ä»¥é‡‡ç”¨ä¸Šé¢ä¸¤ç§æ–¹æ³•è·å–æŒ‡é’ˆã€‚

# å…¶ä½™ä¸å¸¸è§çš„æŒ‡é’ˆ

å› ä¸ºå¾ˆä¸å¸¸è§ï¼Œæ‰€ä»¥å°±ä¸€ç¬”å¸¦è¿‡äº†

- `OpaquePointer`ï¼šä¸€ä¸ªä¸é€æ˜çš„CæŒ‡é’ˆçš„åŒ…è£…ï¼Œç”¨äºè¡¨ç¤ºä¸èƒ½ç”¨Swiftè¡¨ç¤ºçš„ç±»å‹çš„CæŒ‡é’ˆï¼Œä¾‹å¦‚ä¸å®Œæ•´çš„structç±»å‹ã€‚
- `ManagedBufferPointer`ï¼šåŒ…å«ä¸€ä¸ªbufferå¯¹è±¡ï¼Œå¹¶æä¾›å¯¹`Header`å®ä¾‹ï¼Œä»¥åŠå¯¹å­˜å‚¨åœ¨è¯¥ç¼“å†²åŒºä¸­çš„ä»»æ„æ•°é‡çš„`Element`å®ä¾‹çš„è¿ç»­å­˜å‚¨çš„è®¿é—®ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ`ManagedBuffer`ç±»å¯ä»¥å¾ˆå¥½åœ°æ»¡è¶³è¿™ä¸ªç›®çš„ï¼Œå¹¶ä¸”å¯ä»¥å•ç‹¬ä½¿ç”¨ã€‚ç„¶è€Œï¼Œåœ¨ä¸åŒç±»çš„å¯¹è±¡å¿…é¡»ç”¨ä½œå­˜å‚¨çš„æƒ…å†µä¸‹ï¼Œå°±éœ€è¦`ManagedBufferPointer`ã€‚
- `AutoreleasingUnsafeMutablePointer`ï¼šä¸€ä¸ªå¯å˜æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªä¸æ‹¥æœ‰ç›®æ ‡çš„Objective-Cå¼•ç”¨ï¼Œ`Pointee`å¿…é¡»æ˜¯ä¸€ä¸ªç±»ç±»å‹æˆ–`Optional<C>`ï¼Œå…¶ä¸­`C`æ˜¯ä¸€ä¸ªç±»ã€‚è¯¥ç±»å‹æœ‰éšå¼è½¬æ¢ï¼Œå…è®¸å°†ä»¥ä¸‹ä»»ä½•ä¸€ç§ä¼ é€’ç»™`C`æˆ–`ObjC`çš„API:
    - `nil`ï¼Œå®ƒä½œä¸ºä¸€ä¸ªç©ºæŒ‡é’ˆä¼ é€’ã€‚
    - å¼•ç”¨ç±»å‹çš„`inout`å‚æ•°ï¼Œå®ƒä½œä¸ºä¸€ä¸ªæŒ‡é’ˆä¼ é€’ç»™ä¸€ä¸ªå›å†™ä¸´æ—¶å¯¹è±¡ï¼Œè¯¥ä¸´æ—¶å¯¹è±¡å…·æœ‰è‡ªåŠ¨é‡Šæ”¾æ‰€æœ‰æƒè¯­ä¹‰ã€‚
    - '`UnsafeMutablePointer<Pointee>`ï¼ŒæŒ‰åŸæ ·ä¼ é€’ã€‚
- `CVaListPointer`ï¼šç©ºç»“æ„ä½“ï¼Œä¸çŸ¥é“å•¥ä½œç”¨ã€‚ã€‚

# å‚è€ƒæ–‡çŒ®

- [Unsafe Swift: Using Pointers and Interacting With C](https://link.juejin.cn/?target=https%3A%2F%2Fwww.raywenderlich.com%2F7181017-unsafe-swift-using-pointers-and-interacting-with-c)
- [stackoverflow](https://link.juejin.cn/?target=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F47940167%2Funsaferawpointer-assumingmemorybound-vs-bindmemory)
- [ç¥ç§˜çš„Builtinæ¨¡å—](https://link.juejin.cn/?target=https%3A%2F%2Fwww.jianshu.com%2Fp%2Fa9e07f660a84)
# [è¯‘] Swift - ç½‘ç»œå•å…ƒæµ‹è¯• - æ˜é‡‘

<aside>
ğŸ’¡ ç®€è¦ï¼š

- å¦‚ä½•ä½¿ç”¨ä¾èµ–æ³¨å…¥æŠ€æœ¯æ¥è®¾è®¡ä¸€ä¸ªå¯¹è±¡ //ä¸ºæ›¿æ¢æˆMockæä¾›å¯èƒ½
- å¦‚ä½•åœ¨Swiftä¸­ä½¿ç”¨åè®®è®¾è®¡æ¨¡æ‹Ÿå¯¹è±¡ //å®šä¹‰æµ‹è¯•å¯¹è±¡æ–¹æ³•
- å¦‚ä½•æµ‹è¯•å¯¹è±¡ä½¿ç”¨çš„æ•°æ®ã€å¦‚ä½•æµ‹è¯•å¯¹è±¡çš„è¡Œä¸º // æ›¿æ¢æµ‹è¯•ç”¨è‡ªå®šä¹‰è¡Œä¸º
</aside>

[åŸæ–‡åœ°å€](https://link.juejin.cn/?target=https%3A%2F%2Fmedium.com%2Fflawless-app-stories%2Fthe-complete-guide-to-network-unit-testing-in-swift-db8b3ee2c327)

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºæµ‹è¯•101çš„å¼€å§‹:*ä¾èµ–æ³¨å…¥*ã€‚ å‡è®¾æ‚¨æ­£åœ¨ç¼–å†™æµ‹è¯•ã€‚

å¦‚æœæ‚¨çš„æµ‹è¯•ç›®æ ‡(SUTï¼Œç³»ç»Ÿæµ‹è¯•)åœ¨æŸç§ç¨‹åº¦ä¸Šä¸ç°å®ä¸–ç•Œ(å¦‚è”ç½‘å’ŒCoreData)ç›¸å…³ï¼Œé‚£ä¹ˆç¼–å†™æµ‹è¯•ä»£ç å°±ä¼šæ›´åŠ å¤æ‚ã€‚åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬ä¸å¸Œæœ›æˆ‘ä»¬çš„æµ‹è¯•ä»£ç ä¾èµ–äºç°å®ä¸–ç•Œçš„ä¸œè¥¿ã€‚SUTä¸åº”ä¾èµ–äºå…¶ä»–å¤æ‚ç³»ç»Ÿï¼Œä»¥ä¾¿æˆ‘ä»¬èƒ½å¤Ÿæ›´å¿«åœ°æµ‹è¯•å®ƒï¼Œæ—¶ä¸å˜å’Œç¯å¢ƒä¸å˜ã€‚æ­¤å¤–ï¼Œé‡è¦çš„æ˜¯æˆ‘ä»¬çš„æµ‹è¯•ä»£ç ä¸ä¼šâ€œæ±¡æŸ“â€ç”Ÿäº§ç¯å¢ƒã€‚æ±¡æŸ“æ˜¯ä»€ä¹ˆæ„æ€?è¿™æ„å‘³ç€æˆ‘ä»¬çš„æµ‹è¯•ä»£ç å‘æ•°æ®åº“å†™å…¥ä¸€äº›æµ‹è¯•å†…å®¹ï¼Œå‘ç”Ÿäº§æœåŠ¡å™¨æäº¤ä¸€äº›æµ‹è¯•æ•°æ®ï¼Œç­‰ç­‰ã€‚è¿™å°±æ˜¯â€œä¾èµ–æ³¨å…¥â€å­˜åœ¨çš„åŸå› ã€‚

è®©æˆ‘ä»¬ä»ä¸€ä¸ªä¾‹å­å¼€å§‹ã€‚

ç»™å®šä¸€ä¸ªåº”è¯¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é€šè¿‡internetæ‰§è¡Œçš„ç±»ã€‚internetéƒ¨åˆ†ç§°ä¸ºè¯¥ç±»çš„â€œä¾èµ–é¡¹â€ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œå½“æˆ‘ä»¬è¿è¡Œæµ‹è¯•æ—¶ï¼Œè¯¥ç±»çš„internetéƒ¨åˆ†å¿…é¡»èƒ½å¤Ÿè¢«ä¸€ä¸ªæ¨¡æ‹Ÿçš„æˆ–å‡çš„ç¯å¢ƒæ‰€æ›¿ä»£ã€‚æ¢å¥è¯è¯´ï¼Œè¿™ä¸ªç±»çš„ä¾èµ–å…³ç³»å¿…é¡»æ˜¯â€œå¯æ³¨å…¥çš„â€ã€‚ä¾èµ–æ³¨å…¥ä½¿æˆ‘ä»¬çš„ç³»ç»Ÿæ›´åŠ çµæ´»ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ç”Ÿäº§ä»£ç ä¸­â€œæ³¨å…¥â€çœŸå®çš„ç½‘ç»œç¯å¢ƒã€‚åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥â€œæ³¨å…¥â€æ¨¡æ‹Ÿç½‘ç»œç¯å¢ƒä»¥åœ¨ä¸è®¿é—®internetçš„æƒ…å†µä¸‹è¿è¡Œæµ‹è¯•ä»£ç ã€‚

# Dependency Injection (DI)ï¼ˆä¾èµ–æ³¨å…¥ï¼‰

æˆ‘ä»¬å°†å®ç°ä¸€ä¸ªç±»â€œHttpClientâ€ï¼Œå®ƒåº”è¯¥æ»¡è¶³ä»¥ä¸‹è¦æ±‚

- HttpClientåº”è¯¥æäº¤ä¸è¢«åˆ†é…çš„URLç›¸åŒçš„è¯·æ±‚ã€‚
- HttpClientåº”è¯¥æäº¤è¯·æ±‚ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬å®ç°äº† HttpClient:

```swift
class HttpClient {
    typealias completeClosure = ( _ data: Data?, _ error: Error?)->Void
    func get( url: URL, callback: @escaping completeClosure ) {
        let request = URLRequest(url: url)
        request.httpMethod = "GET"
        let task = URLSession.shared.dataTask(with: request) { (data, response, error) in
            callback(data, error)
        }
        task.resume()
    }
}
å¤åˆ¶ä»£ç 
```

HttpClient ä¼¼ä¹å¯ä»¥æäº¤ä¸€ä¸ªâ€œGETâ€è¯·æ±‚ï¼Œå¹¶é€šè¿‡é—­åŒ…â€œå›è°ƒâ€ä¼ é€’è¿”å›å€¼ã€‚

```swift
HttpClient().get(url: url) { (success, response) in // Return data }
å¤åˆ¶ä»£ç 
```

HttpClient çš„ä½¿ç”¨ï¼š

é—®é¢˜æ˜¯ï¼šæˆ‘ä»¬å¦‚ä½•æµ‹è¯•å®ƒ?æˆ‘ä»¬å¦‚ä½•ç¡®ä¿ä»£ç æ»¡è¶³ä¸Šé¢åˆ—å‡ºçš„éœ€æ±‚?ç›´è§‚åœ°è¯´ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»£ç ï¼Œå°†URLåˆ†é…ç»™HttpClientï¼Œç„¶ååœ¨æ§åˆ¶å°ä¸­è§‚å¯Ÿç»“æœã€‚ç„¶è€Œï¼Œè¿™æ ·åšæ„å‘³ç€æˆ‘ä»¬æ¯æ¬¡å®ç°HttpClientæ—¶éƒ½å¿…é¡»è¿æ¥åˆ°internetã€‚å¦‚æœæµ‹è¯•URLä½äºç”Ÿäº§æœåŠ¡å™¨ä¸Šï¼Œæƒ…å†µä¼¼ä¹æ›´ç³Ÿ:æ‚¨çš„æµ‹è¯•è¿è¡Œç¡®å®ä¼šåœ¨ä¸€å®šç¨‹åº¦ä¸Šå½±å“æ€§èƒ½ï¼Œå¹¶ä¸”æ‚¨çš„æµ‹è¯•æ•°æ®å°†æäº¤ç»™ç°å®ä¸–ç•Œã€‚å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿HttpClientâ€œå¯æµ‹è¯•â€ã€‚

è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹URLSessionã€‚URLSessionæ˜¯HttpClientçš„ä¸€ç§â€œç¯å¢ƒâ€ï¼Œå®ƒæ˜¯internetçš„ç½‘å…³ã€‚è¿˜è®°å¾—æˆ‘ä»¬è¯´çš„â€œå¯æµ‹è¯•â€ä»£ç å—?æˆ‘ä»¬å¿…é¡»ä½¿äº’è”ç½‘çš„ç»„æˆéƒ¨åˆ†æ˜¯å¯æ›¿æ¢çš„ã€‚æ‰€ä»¥æˆ‘ä»¬ç¼–è¾‘HttpClient:

```swift
class HttpClient {
    typealias completeClosure = ( _ data: Data?, _ error: Error?)->Void
    private let session: URLSessionProtocol
    init(session: URLSessionProtocol) {
        self.session = session
    }
    func get( url: URL, callback: @escaping completeClosure ) {
        let request = URLRequest(url: url)
        request.httpMethod = "GET"
        let task = session.dataTask(with: request) { (data, response, error) in
            callback(data, error)
        }
        task.resume()
    }
}
å¤åˆ¶ä»£ç 
```

We replace the

```swift
let task = URLSession.shared.dataTask()
å¤åˆ¶ä»£ç 
```

with

```swift
let task = session.dataTask()
å¤åˆ¶ä»£ç 
```

ç„¶åæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæ–°çš„å˜é‡:**session**ï¼Œæ·»åŠ ä¸€ä¸ªç›¸åº”çš„**init**ã€‚ä»ç°åœ¨å¼€å§‹ï¼Œå½“æˆ‘ä»¬åˆ›å»ºHttpClientæ—¶ï¼Œæˆ‘ä»¬å¿…é¡»åˆ†é…**session**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¿…é¡»å°†ä¼šè¯â€œæ³¨å…¥â€åˆ°æˆ‘ä»¬åˆ›å»ºçš„ä»»ä½•HttpClientå¯¹è±¡ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨' URLSessionè¿è¡Œç”Ÿäº§ä»£ç äº†ã€‚å¹¶ä½¿ç”¨ä¸€ä¸ªè¢«æ³¨å…¥çš„æ¨¡æ‹Ÿä¼šè¯è¿è¡Œæµ‹è¯•ä»£ç ã€‚

HttpClientçš„ä½¿ç”¨å˜æˆäº†ï¼š

```swift
HttpClient(session: SomeURLSession()).get(url: url){(dataï¼Œresponse, error) in
    // Return data
}
å¤åˆ¶ä»£ç 
```

ä¸ºè¿™ä¸ªHttpClientç¼–å†™æµ‹è¯•ä»£ç å˜å¾—éå¸¸å®¹æ˜“ã€‚æ‰€ä»¥æˆ‘ä»¬è®¾ç½®æµ‹è¯•ç¯å¢ƒ:

```swift
class HttpClientTests: XCTestCase {
    var httpClient: HttpClient!
    let session = MockURLSession()
    override func setUp() {
        super.setUp()
        httpClient = HttpClient(session: session)
    }
    override func tearDown() {
        super.tearDown()
    }
}
å¤åˆ¶ä»£ç 
```

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„XCTestCaseè®¾ç½®ã€‚å˜é‡httpClientæ˜¯è¢«æµ‹è¯•ç³»ç»Ÿ(SUT)ï¼Œå˜é‡sessionæ˜¯æˆ‘ä»¬å°†æ³¨å…¥åˆ°httpClientçš„ç¯å¢ƒã€‚å› ä¸ºæˆ‘ä»¬åœ¨æµ‹è¯•ç¯å¢ƒä¸­è¿è¡Œä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†MockURLSessionå¯¹è±¡åˆ†é…ç»™sessionã€‚ç„¶åæˆ‘ä»¬å°†æ¨¡æ‹Ÿä¼šè¯æ³¨å…¥åˆ°httpClientã€‚å®ƒä½¿httpClientè¿è¡Œåœ¨MockURLSessionä¸Šï¼Œè€Œä¸æ˜¯URLSession.sharedä¸Šã€‚

# Test data

ç°åœ¨æˆ‘ä»¬å…³æ³¨æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªè¦æ±‚:

- HttpClientåº”è¯¥ç”¨ä¸è¢«åˆ†é…çš„URLç›¸åŒçš„URLæäº¤è¯·æ±‚ã€‚ æˆ‘ä»¬å¸Œæœ›ç¡®ä¿è¯·æ±‚çš„urlä¸æˆ‘ä»¬åœ¨å¼€å§‹åˆ†é…ç»™â€œgetâ€æ–¹æ³•çš„urlå®Œå…¨ç›¸åŒã€‚

ä¸‹é¢æ˜¯æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹:

```swift
func test_get_request_withURL() {
    guard let url = URL(string: "https://mockurl") else {
        fatalError("URL can't be empty")
    }
    httpClient.get(url: url) { (success, response) in
        // Return data
    }
    // Assert
}
å¤åˆ¶ä»£ç 
```

è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹å¯ä»¥è¡¨ç¤ºä¸º:

- **Precondition**ï¼šç»™å®šä¸€ä¸ªurlâ€œ[https://mockurl](https://link.juejin.cn/?target=https%3A%2F%2Fmockurl)â€
- **When**ï¼šæäº¤ä¸€ä¸ªhttp GETè¯·æ±‚
- **Assert**ï¼šæäº¤çš„urlåº”è¯¥ç­‰äºâ€œ[https://mockurl](https://link.juejin.cn/?target=https%3A%2F%2Fmockurl)â€

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ç¼–å†™æ–­è¨€éƒ¨åˆ†ã€‚

é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•çŸ¥é“HttpClientçš„â€œgetâ€æ–¹æ³•æ˜¯å¦æäº¤æ­£ç¡®çš„urlå‘¢?è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¾èµ–é¡¹:URLSessionã€‚é€šå¸¸ï¼Œâ€œgetâ€æ–¹æ³•ä½¿ç”¨ç»™å®šçš„urlåˆ›å»ºä¸€ä¸ªè¯·æ±‚ï¼Œå¹¶å°†è¯¥è¯·æ±‚åˆ†é…ç»™URLSessionæ¥æäº¤è¯¥è¯·æ±‚:

```swift
let task = session.dataTask(with: request) { (data, response, error) in
    callback(data, error)
}
task.resume()
å¤åˆ¶ä»£ç 
```

ç°åœ¨ï¼Œåœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼Œè¯·æ±‚è¢«åˆ†é…ç»™MockURLSessionã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä¾µå…¥æˆ‘ä»¬æ‹¥æœ‰çš„MockURLSessionï¼Œä»¥æ£€æŸ¥è¯·æ±‚æ˜¯å¦è¢«æ­£ç¡®åˆ›å»ºã€‚

è¿™æ˜¯MockURLSessionçš„å®ç°:

```swift
class MockURLSession {
    var responseData: Data?
    var responseHeader: HTTPURLResponse?
    var responseError: Error?
    //var sessionDataTask = MockURLSessionDataTask() å¾…ä¼šå®ç°

    private (set) var lastURL: URL?
    func dataTask(with request: URLRequest, completionHandler: @escaping DataTaskResult) -> URLSessionDataTask {
        lastURL = request.url
        completionHandler(responseData, responseHeader, responseError)
        return // dataTask, will be impletmented later
    }
}
å¤åˆ¶ä»£ç 
```

MockURLSessionçš„ä½œç”¨ç±»ä¼¼äºURLSessionã€‚URLSessionå’ŒMockURLSessionéƒ½æœ‰ç›¸åŒçš„æ–¹æ³•dataTask()å’Œç›¸åŒçš„å›è°ƒé—­åŒ…ç±»å‹ã€‚å°½ç®¡URLSessionä¸­çš„dataTask()æ‰§è¡Œçš„ä»»åŠ¡æ¯”MockURLSessionå¤šï¼Œä½†å®ƒä»¬çš„æ¥å£çœ‹èµ·æ¥å¾ˆç›¸ä¼¼ã€‚ç”±äºä½¿ç”¨ç›¸åŒçš„æ¥å£ï¼Œæˆ‘ä»¬èƒ½å¤Ÿç”¨MockURLSessionæ›¿ä»£URLSessionï¼Œè€Œä¸éœ€è¦æ›´æ”¹å¤ªå¤šâ€œgetâ€æ–¹æ³•çš„ä»£ç ã€‚ç„¶åæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå˜é‡lastURLï¼Œä»¥è·Ÿè¸ªåœ¨â€œgetâ€æ–¹æ³•ä¸­æäº¤çš„æœ€ç»ˆurlã€‚ç®€å•åœ°è¯´ï¼Œåœ¨æµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªHttpClientï¼Œå°†MockURLSessionæ³¨å…¥å…¶ä¸­ï¼Œç„¶åæŸ¥çœ‹å‰åçš„urlæ˜¯å¦ç›¸åŒã€‚

æµ‹è¯•ç”¨ä¾‹å°†é•¿è¿™æ ·ï¼š

```swift
func test_get_request_withURL() {
    guard let url = URL(string: "https://mockurl") else {
        fatalError("URL can't be empty")
    }
    httpClient.get(url: url) { (success, response) in
        // Return data
    }
    XCTAssert(session.lastURL == url)
}
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬æ–­è¨€å¸¦æœ‰urlçš„lastURLï¼Œä»¥æŸ¥çœ‹â€œgetâ€æ–¹æ³•æ˜¯å¦æ­£ç¡®åœ°ç”¨æ­£ç¡®çš„urlåˆ›å»ºè¯·æ±‚ã€‚

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œè¿˜æœ‰ä¸€ä»¶äº‹éœ€è¦å®ç°:return // dataTaskã€‚åœ¨URLSessionä¸­ï¼Œè¿”å›å€¼å¿…é¡»æ˜¯URLSessionDataTaskã€‚ç„¶è€Œï¼ŒURLSessionDataTaskä¸èƒ½é€šè¿‡ç¼–ç¨‹æ–¹å¼åˆ›å»ºï¼Œå› æ­¤ï¼Œè¿™æ˜¯ä¸€ä¸ªéœ€è¦æ¨¡æ‹Ÿçš„å¯¹è±¡:

```swift
class MockURLSessionDataTask {
    func resume() { }
}
å¤åˆ¶ä»£ç 
```

ä¸URLSessionDataTaskä¸€æ ·ï¼Œè¿™ä¸ªmockå…·æœ‰ç›¸åŒçš„æ–¹æ³•resume()ã€‚å› æ­¤ï¼Œå®ƒå¯ä»¥å°†è¿™ä¸ªmockå¤„ç†ä¸ºdataTask()çš„è¿”å›å€¼ã€‚

ç„¶åï¼Œä½ ä¼šå‘ç°ä¸€äº›ç¼–è¯‘é”™è¯¯åœ¨ä½ çš„ä»£ç :

```swift
class HttpClientTests: XCTestCase {
    var httpClient: HttpClient!
    let session = MockURLSession()
    override func setUp() {
        super.setUp()
        httpClient = HttpClient(session: session) // Doesn't compile
    }
    override func tearDown() {
        super.tearDown()
    }
}
å¤åˆ¶ä»£ç 
```

MockURLSessionçš„æ¥å£ä¸URLSessionçš„æ¥å£ä¸åŒã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬å°è¯•æ³¨å…¥MockURLSessionæ—¶ï¼Œç¼–è¯‘å™¨å°†æ— æ³•è¯†åˆ«å®ƒã€‚æˆ‘ä»¬å¿…é¡»ä½¿æ¨¡æ‹Ÿå¯¹è±¡çš„æ¥å£ä¸çœŸå®å¯¹è±¡ç›¸åŒã€‚é‚£ä¹ˆï¼Œè®©æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹â€œåè®®â€!

HttpClientçš„ä¾èµ–å…³ç³»æ˜¯: `private let session: URLSession`

æˆ‘ä»¬å¸Œæœ›ä¼šè¯æ˜¯URLSessionæˆ–MockURLSessionã€‚æ‰€ä»¥æˆ‘ä»¬æŠŠç±»å‹ä»URLSessionæ”¹ä¸ºåè®®URLSessionProtocol: `private let session: URLSessionProtocol`

ç°åœ¨æˆ‘ä»¬å¯ä»¥æ³¨å…¥URLSessionæˆ–MockURLSessionæˆ–ä»»ä½•ç¬¦åˆæ­¤åè®®çš„å¯¹è±¡ã€‚

è¿™æ˜¯åè®®çš„å®ç°ï¼š

```swift
protocol URLSessionProtocol { typealias DataTaskResult = (Data?, URLResponse?, Error?) -> Void
    func dataTask(with request: NSURLRequest, completionHandler: @escaping DataTaskResult) -> URLSessionDataTaskProtocol
}
å¤åˆ¶ä»£ç 
```

åœ¨æˆ‘ä»¬çš„æµ‹è¯•ä»£ç ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªæ–¹æ³•:`dataTask(NSURLRequest, DataTaskResult)`ï¼Œå› æ­¤æˆ‘ä»¬åœ¨åè®®ä¸­åªå®šä¹‰äº†ä¸€ä¸ªå¿…éœ€çš„æ–¹æ³•ã€‚å½“æˆ‘ä»¬æƒ³è¦å˜²ç¬‘æˆ‘ä»¬å¹¶ä¸æ‹¥æœ‰çš„ä¸œè¥¿æ—¶ï¼Œé€šå¸¸ä¼šé‡‡ç”¨è¿™ç§æŠ€å·§ã€‚

è¿˜è®°å¾—MockURLDataTaskå—?è¿™æ˜¯å¦ä¸€ä¸ªæˆ‘ä»¬ä¸æ‹¥æœ‰çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºå¦ä¸€ä¸ªåè®®ã€‚

```swift
protocol URLSessionDataTaskProtocol { func resume() }
å¤åˆ¶ä»£ç 
```

We also have to make the real objects conform the protocols.

```swift
extension URLSession: URLSessionProtocol {}
extension URLSessionDataTask: URLSessionDataTaskProtocol {}
å¤åˆ¶ä»£ç 
```

URLSessionDataTaskå…·æœ‰å®Œå…¨ç›¸åŒçš„åè®®æ–¹æ³•resume()ï¼Œå› æ­¤URLSessionDataTaskä¸ä¼šå‘ç”Ÿä»»ä½•äº‹æƒ…ã€‚

é—®é¢˜æ˜¯ï¼ŒURLSessionæ²¡æœ‰dataTask()è¿”å›URLSessionDataTaskProtocolã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ‰©å±•ä¸€ä¸ªæ–¹æ³•æ¥éµå®ˆåè®®ã€‚

```swift
extension URLSession: URLSessionProtocol {
    func dataTask(with request: NSURLRequest, completionHandler: @escaping DataTaskResult) -> URLSessionDataTaskProtocol {
        return dataTask(with: request, completionHandler: completionHandler) as URLSessionDataTask as URLSessionDataTaskProtocol
    }
}
å¤åˆ¶ä»£ç 
```

è¿™æ˜¯ä¸€ä¸ªå°†è¿”å›ç±»å‹ä»URLSessionDataTaskè½¬æ¢ä¸ºURLSessionDataTaskProtocolçš„ç®€å•æ–¹æ³•ã€‚å®ƒæ ¹æœ¬ä¸ä¼šæ”¹å˜dataTask()çš„è¡Œä¸ºã€‚

ç°åœ¨æˆ‘ä»¬å¯ä»¥å®ŒæˆMockURLSessionä¸­ç¼ºå¤±çš„éƒ¨åˆ†äº†:

```swift
class MockURLSession: URLSessionProtocol {

    var responseData: Data?
    var responseHeader: HTTPURLResponse?
    var responseError: Error?
    var sessionDataTask = MockURLSessionDataTask()

    private(set) var lastURL: URL?

    /// è¿”å›å€¼ URLSessionDataTask ä¸èƒ½é€šè¿‡ç¼–ç¨‹æ–¹å¼åˆ›å»ºï¼Œå› æ­¤ï¼Œè¿™æ˜¯ä¸€ä¸ªéœ€è¦æ¨¡æ‹Ÿçš„å¯¹è±¡:
    func dataTask(with request: URLRequest, completionHandler: @escaping DataTaskHandler) -> URLSessionDataTaskProtocol {
        lastURL = request.url
        completionHandler(responseData, responseHeader, responseError)
        return sessionDataTask
    }
}

}
å¤åˆ¶ä»£ç 
```

We know the // dataTaskâ€¦ could be a MockURLSessionDataTask:

```swift
class MockURLSession: URLSessionProtocol {
    var nextDataTask = MockURLSessionDataTask()
    private (set) var lastURL: URL?
    func dataTask(with request: NSURLRequest, completionHandler: @escaping DataTaskResult) -> URLSessionDataTaskProtocol {
        lastURL = request.url
        completionHandler(nextData, successHttpURLResponse(request: request), nextError)
        return nextDataTask
    }
}
å¤åˆ¶ä»£ç 
```

è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿï¼Œåœ¨æˆ‘ä»¬çš„æµ‹è¯•ç¯å¢ƒä¸­ç±»ä¼¼äºURLSessionï¼Œå¯ä»¥ä¿å­˜urlä»¥è¿›è¡Œæ–­è¨€

# Test Behavior

ç¬¬äºŒä¸ªè¦æ±‚æ˜¯:

- HttpClientåº”è¯¥æäº¤è¯·æ±‚

æˆ‘ä»¬å¸Œæœ›ç¡®ä¿HttpClientä¸­çš„â€œgetâ€æ–¹æ³•å¦‚æœŸæäº¤è¯·æ±‚ã€‚ ä¸å‰ä¸€ä¸ªæµ‹è¯•æµ‹è¯•æ•°æ®çš„æ­£ç¡®æ€§ä¸åŒï¼Œæ­¤æµ‹è¯•æ–­è¨€æ˜¯å¦è°ƒç”¨äº†æ–¹æ³•ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬æƒ³çŸ¥é“æ˜¯å¦è°ƒç”¨äº†URLSessionDataTask.resume()ã€‚è®©æˆ‘ä»¬ç©è€æŠŠæˆ:

æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°å˜é‡ resumewascall æ¥è®°å½•`resume()`æ–¹æ³•æ˜¯å¦è¢«è°ƒç”¨ã€‚

```swift
func test_get_resume_called() {
    let dataTask = MockURLSessionDataTask()
    session.nextDataTask = dataTask
    guard let url = URL(string: "https://mockurl") else {
        fatalError("URL can't be empty")
    }
    httpClient.get(url: url) { (success, response) in
        // Return data
    }
    XCTAssert(dataTask.resumeWasCalled)
}
å¤åˆ¶ä»£ç 
```

å˜é‡**dataTask**æ˜¯ä¸€ä¸ªmockï¼Œå®ƒå±äºæˆ‘ä»¬è‡ªå·±ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªå±æ€§æ¥æµ‹è¯•resume()çš„è¡Œä¸º:

```swift
class MockURLSessionDataTask: URLSessionDataTaskProtocol {
    private (set) var resumeWasCalled = false
    func resume() {
        resumeWasCalled = true
    }
}
å¤åˆ¶ä»£ç 
```

å¦‚æœresume()è¢«è°ƒç”¨ï¼Œé‚£ä¹ˆresumeWasCalledå°±ä¼šå˜æˆâ€œtrueâ€)å¾ˆç®€å•,å¯¹å§?

# å›é¡¾

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°: å¦‚ä½•é€‚åº”ä¾èµ–æ³¨å…¥ä»¥æ”¹å˜ç”Ÿäº§/æµ‹è¯•ç¯å¢ƒã€‚ å¦‚ä½•åˆ©ç”¨åè®®åˆ›å»ºæ¨¡æ‹Ÿã€‚ å¦‚ä½•æµ‹è¯•ä¼ é€’å€¼çš„æ­£ç¡®æ€§ã€‚ å¦‚ä½•æ–­è¨€æŸä¸ªå‡½æ•°çš„è¡Œä¸ºã€‚ åœ¨å¼€å§‹æ—¶ï¼Œæ‚¨å¿…é¡»èŠ±è´¹å¤§é‡æ—¶é—´ç¼–å†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•ã€‚è€Œä¸”ï¼Œæµ‹è¯•ä»£ç ä¹Ÿæ˜¯ä»£ç ï¼Œæ‰€ä»¥æ‚¨ä»ç„¶éœ€è¦ä½¿å…¶æ¸…æ™°ä¸”ç»“æ„è‰¯å¥½ã€‚ä½†æ˜¯ç¼–å†™æµ‹è¯•çš„å¥½å¤„æ˜¯æ— ä»·çš„ã€‚åªæœ‰é€šè¿‡é€‚å½“çš„æµ‹è¯•æ‰èƒ½æ‰©å±•ä»£ç ï¼Œè€Œæµ‹è¯•å¯ä»¥å¸®åŠ©æ‚¨é¿å…å¾®å°çš„é”™è¯¯ã€‚æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§! ç¤ºä¾‹ä»£ç åœ¨[GitHub](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fkoromiko%2FTutorial%2Fblob%2Fmaster%2FNetworkingUnitTest.playground%2FContents.swift)ä¸Šã€‚è¿™æ˜¯ä¸€ä¸ªæ¸¸ä¹åœºï¼Œæˆ‘åœ¨é‚£é‡Œå¢åŠ äº†ä¸€ä¸ªæµ‹è¯•ã€‚è¯·éšæ„ä¸‹è½½/æ´¾ç”Ÿå®ƒï¼Œå¹¶æ¬¢è¿ä»»ä½•åé¦ˆ!

# Reference
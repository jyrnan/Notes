# ä¸€ä¸ªæŒ‰é’®å“åº”å’Œä¾æ®æ—¶é—´å‘å¸ƒ/è®¢é˜…çš„èŒƒä¾‹

<aside>
ğŸ’¡ ä»£ç ä¸­`scan`æ˜¯ä¸å¤ªç†è§£çš„ç‚¹ï¼Œæ˜¯Publisherçš„ä¸€ä¸ªæ–¹æ³•ï¼Œæ˜¯æ ¹æ®æä¾›çš„åˆå§‹å€¼ä»¥åŠä¸Šæ¸¸æä¾›çš„è¾“å‡ºå€¼è¿›è¡Œè¿­ä»£è®¡ç®—ï¼Œç”Ÿæˆä¸€ä¸ªå’Œä¸Šæ¸¸Publisherç±»å‹ä¸€è‡´çš„æ–°çš„Publisher.Sequence [å‚è€ƒé“¾æ¥](https://developer.apple.com/documentation/combine/publishers/flatmap/scan(_:_:))

</aside>

```swift
import SwiftUI
import Combine

struct ContentView: View {
    @ObservedObject var counter: TimeCounter
    
    var body: some View {
        VStack{
            Text("\(counter.number)")
            Button(action: counter.setTimer, label: {
                Text("Timer")
            })
            Button(action: counter.stopTimer, label: {
                Text("Stop")
            })
            
            ///ä¸åŒæŒ‰é’®çš„åŠ¨ä½œæ¥è®©publisherå‘é€ä¸åŒçš„è¡Œä¸º
            Button(action: counter.increase, label: {
                Text("+")
            })
            Button(action: counter.decrease, label: {
                Text("-")
            })
        }
    }
    
    var MyText: some View {
        Text("hello")
    }
}

struct ContentView_Previews: PreviewProvider {
    
    static var previews: some View {
        ContentView(counter: TimeCounter())
    }
}

class TimeCounter: ObservableObject {
    @Published var number: Int = 0
    
    ///è¿™æ˜¯å¦ä¸€ä¸€ä¸ªåŸºäºæ—¶é—´çš„pulisher
    var timer: AnyCancellable?
    
    ///ä¸€ä¸ªåŸºäºæŒ‰é’®åŠ¨ä½œçš„publisherï¼Œæ¯æ¬¡æŒ‰é’®åŠ¨ä½œéƒ½ä¼šè®©è¿™ä¸ªpublisherå‘å¸ƒä¸€ä¸ªæ•°æ®ï¼Œæ•°æ®ç±»å‹æ˜¯Action
    ///ä¸åŒçš„æŒ‰é’®ä¼šå‘å¸ƒä¸åŒç±»å‹çš„Actionï¼Œç”¨æ¥åŠ ä»¥åŒºåˆ«
    var actionPublisher: PassthroughSubject = PassthroughSubject<Action, Never>()
    
    ///åˆ›å»ºä¸€ä¸ªSetç”¨æ¥ä¿æŒä½ç”Ÿæˆçš„å‘å¸ƒ/è®¢é˜…ç»„åˆï¼Œä½¿ä¹‹ä¸æ–­äº§ç”Ÿ/æ¶ˆè´¹æ•°æ®ï¼Œè€Œä¸ä¼šè¢«é”€æ¯
    var actionToken: Set<AnyCancellable> = Set()
    
    init() {
        ///åˆå§‹åŒ–çš„æ—¶å€™æ¥è®¾ç½®ä¸€ä¸ªåŠ¨ä½œçš„publisherï¼Œå¹¶åœ¨actionTokenä¸­ä¿æŒä½è¿™ä¸ªpublisher
        setButton()
    }
    
    func setTimer() {
        timer = Timer.publish(every: 1, on: .main, in: .default)
            .autoconnect()
            .scan(0){value, _ in value + 1}
            .map{print($0)}
            .sink(receiveValue: {date in self.number += 1})
    }
    
    func setButton() {
        actionPublisher
            ///[scan](https://developer.apple.com/documentation/combine/publishers/flatmap/scan(_:_:))ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸Šæ¸¸Publisherä¼ å…¥çš„æ•°æ®ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªActionå®ä¾‹
            ///æ ¹æ®ä¼ å…¥çš„Actionç±»å‹æ¥åˆ¤æ–­é‡‡ç”¨ä¸åŒçš„è¿”å›å€¼ï¼ˆ+1æˆ–-1ï¼‰
            ///scanå°†æŒ‰é’®æŒ‰ä¸‹ä¼ å…¥çš„ä¿¡å·è½¬å˜æˆä¸€ä¸ªæ•°æ®å†æ¬¡è¾“å‡º
            .scan(0){value, action in
                switch action {
                case .increase: return value + 1
                case .decrease: return value - 1
                }
            }
            ///assignè·å–åˆ°scanä¼ å…¥çš„æ•°æ®åèµ‹å€¼åˆ°ç›¸åº”çš„ä½ç½®
            .assign(to: \.number, on: self)
            ///æˆ–è€…é‡‡ç”¨sinkæ¥ä½œä¸ºæœ€ç»ˆçš„è®¢é˜…è€…ï¼Œé’ˆå¯¹ä¼ å…¥çš„æ•°æ®æ¥è°ƒç”¨é—­åŒ…
            //            .sink(receiveValue: {action in
            //            switch action {
            //            case .increase: self.number += 1
            //            case .decrease: self.number -= 1
            //            }
            //        })
            ///storeå¯ä»¥å°†è®¢é˜…äº§ç”Ÿçš„ä¸€ä¸ªAnyCanellableä¿å­˜åˆ°ä¸€ä¸ªSeté‡Œé¢ç”¨æ¥holdä½
            .store(in: &actionToken)
    }
    
    func stopTimer() {
        timer?.cancel()
    }
    
    ///è®©publisherå‘é€ä¸€ä¸ªactionï¼Œç±»å‹æ˜¯.increase
    func increase() {
        actionPublisher.send(.increase)
    }
    
    ///è®©publisherå‘é€ä¸€ä¸ªactionï¼Œç±»å‹æ˜¯.decrease
    func decrease() {
        actionPublisher.send(.decrease)
    }
}

///å®šä¹‰Actionçš„ç±»å‹ï¼Œç”¨æ¥ä½œä¸ºä¸åŒçš„æŒ‰é’®è¾“å‡ºä¸åŒçš„actionåŠ ä»¥åŒºåˆ«
enum Action {
    case increase
    case decrease
}
```
# 分层设计

MVC 三层架构只是概念层面的指导思想，我们会将层次结构划分的更加细致。现在，我们来深入探讨“**如何合理的设计代码分层，论代码分层的设计之道**”。

在笔者看来，合理的代码分层应该是这样的。如图所示。

![Untitled](%E5%88%86%E5%B1%82%E8%AE%BE%E8%AE%A1%20e5f2ae8390fe4c3abd3c09d920577e83/Untitled.png)

**请求处理层**具有三块能力，一个是通过模板引擎渲染，例如 FreeMarket、Velocity 的页面渲染，以及通过 Controller 层封装的 RESTful API 的 HTTP 接口。如果项目中用到了 Dubbo、HSF、Thrift 等 RPC 服务，我们还需要提供对于的服务给上游的业务方使用，它通过 Service 来实现并暴露成 RPC 接口。这里，Service 的命名是相对的，一般通过 Client 提供接口，通过 Service 实现具体的业务逻辑。

**业务逻辑层** 的职责是与**数据持久层**交互，对多个数据源的操作进行聚合，并且提供组合复用的能力。此外，它也是业务通用能力的处理层，其中还包括`缓存方案`、`消息监听（MQ）`、`定时任务`等等。此外，我们要将尽可能多的业务处理放在**业务逻辑层**，包括了`参数校验`、`数据转换`、`异常处理`等，而不是在 Controller 再去处理。

**数据持久层** 承载了数据存储和访问的能力，它既与底层数据进行交换，包括 MySQL、Oracle、Redis、MongoDB、ElasticSearch、PostgreSQL、HBase 等，又通过 `Proxy` 的代理和包装与远程服务数据进行联动。**因此，在业务逻辑层调用时，它对底层的数据实现方式是无感知的，无论是哪种数据存储方式，以及它是远程数据，还是本地数据，都可以非常容易的调用**。换句话说，我们需要将数据的查询和更改操作限制在数据持久层，并只能被业务逻辑层访问。

> 那么，我们可以跨层级调用吗？笔者认为：我们需要禁止跨层级调用，因为每个层级都自己的职责，并且对上层而言是透明的，就像 OSI 七层协议模型和 TCP/IP 四层协议模型一样，只有将职责限制在自己的边界内，整体层次结构才清晰明了。那么对于同级调用，笔者认为在业务逻辑层是允许的，但是，要特别注意循环调用的产生。
> 

## VO、BO、DO、DTO。

现在，我们再横向理解几个领域模型：VO、BO、DO、DTO。这个概念，是由阿里编码规约提到的，由于其业务非常复杂，因此为了更好地进行领域建模和模型隔离，提出了这几个概念。

**DO（Data Object）**与数据库表结构一一对应，通过 DAO 层向上传输数据源对象。 

而 DTO（Data Transfer Object）是远程调用对象，它是 RPC 服务提供的领域模型。注意的是，对于 DTO 一定要保证其序列化，实现 Serializable 接口，并显示提供 serialVersionUID，否则在反序列化时，如果 serialVersionUID 被修改，那么反序列化会失败。**事实上，DO 和 DTO 唯一的区别在于，一个是本地数据源的领域模型，一个是远程服务的序列化领域模型。**

**BO（Business Object）**，它是业务逻辑层封装业务逻辑的对象，一般情况下，它是聚合了多个数据源的复合对象。

**VO（View Object）** 通常是请求处理层传输的对象，它通过 Spring 框架的转换后，往往是一个 JSON 对象。

## FetchMee的分层示意图

![Untitled](%E5%88%86%E5%B1%82%E8%AE%BE%E8%AE%A1%20e5f2ae8390fe4c3abd3c09d920577e83/Untitled%201.png)
# Chapter 9  虚拟内存

为了更加有效地管理内存并且少出错，现代系统提供了 一 种对主存的抽象概念，叫做 虚拟内存 (VM) 。

它为每个进程提供了一个大的、 一 致的和私有的地址空间 。

虚拟内存提供了三个重要的能力: 

1. 它将主存看成是 一 个存储在磁盘上的地址空间的 高速缓存，在主存中只保存活动区域，并根据需要在磁盘和 主存之间来回传送数据，通过 这种方式，它高效地使用了主存 。 
2. 它为每个进程提供了一致的地址空间，从而简化了内 存管理。（一致是什么意思？） 
3. 它保护了每个进程的地址空间不被其他进程破坏 。

## 9.1 物理和虚拟寻址

使用虚拟寻址， CPU 通过生成一个虚拟地址 (Virtual Address, VA) 来访问主存，这 个虚拟地址在被送到内存之前先转换成适当的物理地址。将 一 个虚拟地址转换为物理地址 的任务叫做地址翻译 (address translation) 。就像异常处理一样，地址翻译 需要 CPU 硬件 和操作系统之间的紧密合作 。 CPU 芯片上叫做内存管理单元 (Memory Management Unit, MMU) 的专用硬件，利用存放在主存中的查询表来动态翻译虚拟地址，该表的内容由操作 系统管理。

## 9.2 地址空间

### 9.3.2 页表

同任何缓存一样，虚拟内存系统必须有某种方法来判定一个虚拟页是否缓存在 DRAM 中的某个地方 。 如果是，系统还必须确定这个虚拟页存放在哪个物理页中。如果 不命中，系统必须判断这个虚拟页存放在磁盘的哪个位置，在物理内存中选择一个牺牲 页，并将虚拟页从磁盘复制到 DRAM 中，替换这个牺牲页。
这些功能是由软硬件联合提供的，包括操作系统软件、 MMU( 内存管理单元)中的地 址翻译硬件和一个存放在物理内存中叫做**页表 (page table)** 的数据结构，页表将虚拟页映 射到物理页。每次地址翻译硬件将一个虚拟地址转换为物理地址时，都会读取页表 。 操作 系统负责维护页表的内容，以及在磁盘与 DRAM 之间来回传送页。

## 小结

虚拟内存是对主存的一个抽象。支持虚拟内存的处理器通过使用一种叫做虚拟寻址的间接形式来引用主存。处理器产生一个虚拟地址，在被发送到主存之前，这个地址被翻译成 一 个物理地址。从虚拟地 址空间到物理地址空间的地址翻译要求硬件和软件紧密合作。专门的硬件通过使用页表来翻译虚拟地址， 而页表的内容是由操作系统提供的。

虚拟内存提供三个重要的功能。第 一 ，它在主存中自动缓存最近使用的存放磁盘上的虚拟地址空间 的内容。虚拟内存缓存中的块叫做页。对磁盘上页的引用会触发缺页，缺页将控制转移到操作系统中的 一个.缺页处理程序。缺页处理程序将页面从磁盘复制到主存缓存，如果必要，将写回被驱逐的页。第二， 虚拟内存简化了内存管理，进而又简化了链接、在进程间共享数据、进程的内存分配以及程序加载。最 后，虚拟内存通过在每条页表条目中加入保护位，从而了简化了内存保护。
地址翻译的过程必须和系统中所有的硬件缓存的操作集成在一起。大多数页表条目位于 L1 高速缓 存中，但是一个称为 TLB 的页表条目的片上高速缓存，通常会消除访问在 L1 上的页表条目的开销。

现代系统通过将虚拟内存片和磁盘上的文件片关联起来，来初始化虚拟内存片，这个过程称为内存 映射。内存映射为共享数据、创建新的进程以及加载程序提供了一种高效的机制。应用可以使用 mmap 函 数来手工地创建和删除虚拟地址空间的区域。然而，大多数程序依赖千动态内存分配器，例如 malloc, 它管理虚拟地址空间区域内一个称为堆的区域。动态内存分配器是 一个感觉像系统级程序的应用级程序， 它直接操作内存，而无需类型系统的很多帮助。分配器有两种类型。显式分配器要求应用显式地释放它 们的内存块。隐式分配器(垃圾收集器)自动释放任何未使用的和不可达的块。

对于 C 程序员来说，管理和使用虚拟内存是一件困难和容易出错的任务。常见的错误示例包括:间 接引用坏指针，读取未初始化的内存，允许栈缓冲区溢出，假设指针和它们指向的对象大小相同，引用 指针而不是它所指向的对象，误解指针运算，引用不存在的变量，以及引起内存泄漏。
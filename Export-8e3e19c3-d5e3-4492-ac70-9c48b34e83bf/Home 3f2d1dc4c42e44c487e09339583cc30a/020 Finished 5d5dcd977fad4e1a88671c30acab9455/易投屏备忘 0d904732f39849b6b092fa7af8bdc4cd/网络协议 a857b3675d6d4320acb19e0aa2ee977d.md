# 网络协议

## 包结构

| 字段 | 字段长度 |
| --- | --- |
| Packet Header | 4 |
| Packet Body | 不定长 |

### **Packet Header协议包头格式**

| 字段 | 字段长度 | 描述 |
| --- | --- | --- |
| Packet Len | 2 | 包体的长度。
 |
| Packet Cmd | 2 | 命令字。定义见具体协议包
 
注：
1、 主动发送的命令包的值，应该是0x0 ～ 0x7fff |

## 端口

### 设备发现

（客户端）广播发送端口：**8000**， 广播接收端口：**8009**    (便于兼容低于9.0协议版本)
组播端口：**10690** 共用发送和接收

### 其他协议

**旧版**基于基于TCP协议。协议TCP监听端口：**8001**

新版协议端口在TV端自动生成，并通过设备发现协议包返回。包括UDP和TCP

## 新旧版本区分

主要在设备发现信息交换过程中发现

- 发送的数据中

| protocol _version | 2 | 表示协议版本
9 （表示本协议），小于9表示旧版本协议，按照旧版本协议定义处理 |
| --- | --- | --- |
- 相应数据

soft_version2表示软件版本（TV端软件版本信息）

## 特殊协议：

### **UDP设备发现数据包**

- 发送包：**命令字** Packet Cmd**： `0x70`**

| 字段 | 字段长度 | 描述 |
| --- | --- | --- |
| service_id | 4 | 旧版本协议中扩展保留，本协议为兼容继续保留 |
| protocol _version | 2 | 表示协议版本
9 （表示本协议），小于9表示旧版本协议，按照旧版本协议定义处理
 |
| dev_type | 2 | 平台类型：
0x2ff  TV
0x100 mobile(android)
0x101 mobile(iOS)
0x102 mobile(windows phone)
0x200 PC
0x201 SetTop Box
0x202 副屏 |
| dev_name | 不定长 | 表示终端具体型号 |
- 响应包**命令字** Packet Cmd**： `0x4070`**

| 字段 | 字段长度 | 描述 |
| --- | --- | --- |
| service_id | 4 |  |
| soft_version | 2 | 表示软件版本（TV端软件版本信息） |
| dev_type | 2 | 平台类型：
0x2ff  TV
0x100 android
0x101 ios
0x102 windows phone
0x201 SetTop Box
0x202 副屏 |
| dev_info | 不定长 | 表示终端具体型号（旧版本）
JSON格式字符串（新版本），举例如下：
"dev_info":{
    "device":{
"devName":"客厅的康佳电视",  //设备名称
"localIp":"192.168.31.211",
"platform":"810",   //平台或品牌
"sdkVersion":"V1.0.0"},  //SDK版本
"encodeData":{
    "serialNumber":"", //序列号、识别码，唯一标识设备
    "macAddress":"",
    "tcpPort":0, //服务端TCP通信端口
"udpPort":0 //服务端UDP通信端口
 
}  //MD5加密数据
} |

### 连接活动命令包

**Packet CMD 包命令字值定义**

**`0x1000`**

**一个连接活动应答命令包**

**Packet CMD 包命令字值定义**

**`0x4001`**

## 其他指令参考

### 终端向TV发送播放文件指令

**Packet CMD 包命令字值定义 `0x2001`**

**Packet Body包体定义**

| 字段 | 字段长度 | 描述 |
| --- | --- | --- |
| file_size | 4 | 文件长度 |
| have_next_flag | 4 | 是否还有要播放的文件 0：没有 1：有 |
| local_ip | 32 | Ip地址 |
| file_name | 不定长 | 要播放的文件路径名(或URL)。
字符串类型utf-8。
 |

**操作目的**：把选定的播放文件名，发给TV播放器，TV播放此文件。

说明：

1. 通过收到的**PlayStat**命令包，判断命令执行的结果。15s内收不到，则执行失败，这个判断时间，由应用待定。
2. TV端解析文件名，来启动播放器。分4种：

图片 &MP

音频 &MA

视频 &MV

文件 &MF

类型添加在文件名最后，如：http://192.168.1.11:8085/1.jpg& MP
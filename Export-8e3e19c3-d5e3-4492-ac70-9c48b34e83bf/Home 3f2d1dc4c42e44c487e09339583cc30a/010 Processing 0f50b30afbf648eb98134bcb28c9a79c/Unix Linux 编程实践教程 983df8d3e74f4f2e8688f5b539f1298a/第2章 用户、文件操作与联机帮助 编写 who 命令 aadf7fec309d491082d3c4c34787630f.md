# 第2章 用户、文件操作与联机帮助: 编写 who 命令

# 2.1 介绍

who命令用来查看有哪些用户正在使用系统，系统是否很繁忙，某人是 否 正 在 使 用 系统等

# 2.2 关于命令who

## 命令也是程序

，在 U n i x 系 统 中 ， 几 乎 所 有 的 命 令 都 是 人 为 编 写 的 程 序 ， 如 who 和1s, 而且它们中的大多数都是用C 语言写的

在Unix 系统中增加新的命令是一件很容易的事。把程序的可执行文件放到以下任意 一 个 目 录 就 可 以 了 : `/ b i n 、/ u s r / b i n 、/ u s r / l o c a l / b i n` ， 这 些 目 录 里 面 存 放 着 很 多 系 统 命 令

## 阅读手册

U n i x 的 联 机 帮 助 分 为 很 多 节 ，如 第 1 小 节 中 是 关 于 用 户 命 令 的 帮 助 ， 第 2 小 节 中 是 关 于 系 统 调 用 的 帮 助 ，第 5 小 节 中 是 关 于 配 置 文 件 的 帮 助。你可查看一 下Uni x 系统的联机帮助，了解其他节讲述的内容。

在联机帮助中，方括号( -a] )表示该选项不是一个必须的部分

# 2.4 问题2:who命令是如何工作的

如何获得UNIX系统的资料
从UINX中学习UNIX

- 阅读联机帮助
- 搜索联机帮助
- 阅读.h文件
- 从参阅部分（see also）

# 2.6 编写cp（读和写）

## 2.6.1 CP命令能做什么

cp能够复制文件，典型用法

`cp source-file target-file`

## 2.6.2 cp命令是如何创建/重写文件

### 创建文件

创建或重写文件的一种方法是通过系统调用函数creat

![Untitled](%E7%AC%AC2%E7%AB%A0%20%E7%94%A8%E6%88%B7%E3%80%81%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B8%8E%E8%81%94%E6%9C%BA%E5%B8%AE%E5%8A%A9%20%E7%BC%96%E5%86%99%20who%20%E5%91%BD%E4%BB%A4%20aadf7fec309d491082d3c4c34787630f/Untitled.png)

例如：

`fd = creat(”addressbook”, 0644);`

### 写文件

用write向系统调用向已经打开的文件中写入数据

![Untitled](%E7%AC%AC2%E7%AB%A0%20%E7%94%A8%E6%88%B7%E3%80%81%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B8%8E%E8%81%94%E6%9C%BA%E5%B8%AE%E5%8A%A9%20%E7%BC%96%E5%86%99%20who%20%E5%91%BD%E4%BB%A4%20aadf7fec309d491082d3c4c34787630f/Untitled%201.png)

## 2.6.3 编写cp

# 2.8 内核缓冲技术

# 2.9 文件读写

## 2.9.3 改变文件的当前位置

内核为每个打开的文件保存一个位置指针。用系统调用lseek来改变文件读写位置

指针是与文件描述符相关联的，而不是与文件关联，所以如果两个程序同时打开一个文 件,这时会有两个指针，两个程序对文件的读操作不会互相干扰。

![Untitled](%E7%AC%AC2%E7%AB%A0%20%E7%94%A8%E6%88%B7%E3%80%81%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B8%8E%E8%81%94%E6%9C%BA%E5%B8%AE%E5%8A%A9%20%E7%BC%96%E5%86%99%20who%20%E5%91%BD%E4%BB%A4%20aadf7fec309d491082d3c4c34787630f/Untitled%202.png)

# 2.10 处理系统调用中的错误

-1是大多系统调用返回代表错误的信息

如何确定发生了那一种错误呢？

### errno

内核通过**全局变量**errno来知名错误的类型，每个程序都可以访问到这个变量。

在error(3)的联机帮助和<errno. h>中包含错误代码和相应的说明

![Untitled](%E7%AC%AC2%E7%AB%A0%20%E7%94%A8%E6%88%B7%E3%80%81%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B8%8E%E8%81%94%E6%9C%BA%E5%B8%AE%E5%8A%A9%20%E7%BC%96%E5%86%99%20who%20%E5%91%BD%E4%BB%A4%20aadf7fec309d491082d3c4c34787630f/Untitled%203.png)

### 不同的错误需要不同的处理

### 显示错误信息：perror(3)

利用perror(string)这个函数，会自行查找错误代码，并在标准错误输出中显示相应的错误信息。参数string是要同时显示出的描述性信息

# 小结

- who 命令通过读系统日志的内容显示当前已经登录的用户。
- Unix系统把数据存放在文件中，可以通过以下系统调用操作文件:
    - open(filename, how)
    - creat (filename, mode)
    - read(fd, buffer, ant)
    - write(fd, buffer, amt)
    - Iseek(fd, distance, base) close(fd)
- 进程对文件的读/ 写都要通过文件描述符,文件描述符表示文件和进程之间的连接。
- 每次系统调用都会导致用户模式和内核模式的切换以及执行内核代码，所以减少程 序中的系统调用发生的次数可以提高程序的运行效率。
- 程序可以通过缓冲技术来减少系统调用的次数,仅当写缓冲区满或读缓冲区空时才 调用内核服务。
- Unix内核可以通过内核绥冲来减少访问磁盘1/0 的次数。
- Unix 中时间的处理方式是记录从某一个时间开始经过的秒数。
- 当系统调用出错时会把全局变量errno 的值设为相应的错误代码，然后返回-1, 程 序可以通过检查errno 来确定错误的类型，并采取相应的措施。
- 这一章涉及的知识在系统中都可以找到，联机帮助中有命令的说明，有些还会涉及命令的实现，头文件中有结构和系统常量的定义，还有函数原型的说明。
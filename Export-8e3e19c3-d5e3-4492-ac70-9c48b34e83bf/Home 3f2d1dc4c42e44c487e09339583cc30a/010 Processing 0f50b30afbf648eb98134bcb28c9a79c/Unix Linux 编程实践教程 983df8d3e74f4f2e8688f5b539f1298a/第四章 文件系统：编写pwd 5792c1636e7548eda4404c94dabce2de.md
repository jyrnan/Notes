# 第四章 文件系统：编写pwd

# 4.2 从用户角度看文件系统

## 4.2.3 文件操作命令

### ln

一个链接是指向文件的一 个指针。.•/a/x和dl/xlink 都指向硬盘上同一数据块

## 4.2.4 针对目录的命令

### ls -R

列出所有子目录的内容

<aside>
🤔 - R 表示递归，指的是包含所有子目录的内容

</aside>

### du

### find

find 命令将在一 个日录及其所有子目录中检素符合要求的文件和目录。

- 尽量缩小查找范围
- 利用*和？通配符，*代表任意数量字符，？代表一个字符

## 4.2.5 目录树的深度几乎没有限制

# 4.3 Unix文件系统的内部结构

一个将磁盘扇区编号的系统使得我们可以把磁盘视为 一系列块的组合

## 4.3.3 磁盘块系列的的抽象：三个区域的划分

整个磁盘的序列可以进一步抽象成三个区域

![Untitled](%E7%AC%AC%E5%9B%9B%E7%AB%A0%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%EF%BC%9A%E7%BC%96%E5%86%99pwd%205792c1636e7548eda4404c94dabce2de/Untitled.png)

### 超级块

存放存储文件系统本身的信息。例如， 超级块记录了每个区域的大小。超级块也存放未被使用的磁盘块的信息。

### i-节点表

每个文件都有一些属性，如大小、文件所有者 和最近修改时间等。这些性质被记录在一个称为i一节点的结构中。所有的i- 节点都有相 同的大小，并且i- 节点表是这些结构的一个列表。文件系统中的每个文件在该表中都有一 个i- 节点。

表中的每个i- 节点都通过位置来标识。例如，标识为2的i- 节点 (inode2)位于文件系统i- 节点表中的第了个位置

### 数据区

文件内容真正存放的位置，有些文件可能不止一个区块

## 4.3.4 文件创建过程

![Untitled](%E7%AC%AC%E5%9B%9B%E7%AB%A0%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%EF%BC%9A%E7%BC%96%E5%86%99pwd%205792c1636e7548eda4404c94dabce2de/Untitled%201.png)

### a 创建i-node，

例如47，记录相关文件信息，包括大小，属性等数据（文件名不在这里）

### b 存储数据

找到合适的数据区的块来存储文件内容，例如找到 627、200、992三个块

### c 记录分配情况

在i-node中添加文件所使用的数据块列表信息，放在序列的前三个位置

### d 添加文件名到目录

文件名是记录在目录文件中，并将文件名和对应的i-node位置记录下来，例如本例中i-node位置是47

## 4.3.5 文件系统的实现：目录的工作过程

目录是一个包含了文件名字列表的特殊文件。不同版本的Unix目录的内部结构不同，但是他们的抽象模型是一致的：**一个包含了i-node号和文件名的表。**

![Untitled](%E7%AC%AC%E5%9B%9B%E7%AB%A0%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%EF%BC%9A%E7%BC%96%E5%86%99pwd%205792c1636e7548eda4404c94dabce2de/Untitled%202.png)

这里最关键的是” . “ 代表了目录本身，节点号是2342

i-节点实际上代表了一个文件，包含了文件的属性和数据块的列表

## 4.3.6 文件系统的实现：cat命令的工作原理

执行这个命令 `cat userlist`

![Untitled](%E7%AC%AC%E5%9B%9B%E7%AB%A0%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%EF%BC%9A%E7%BC%96%E5%86%99pwd%205792c1636e7548eda4404c94dabce2de/Untitled%203.png)

实现cat命令，采用了从目录文件一步步找到数据的方法来加以了解

### 在目录中寻找文件名

文件名存储在目录文件中。内核在目录中查找userlist的记录，对应了47号i-节点

### 定位i - 节点47并读取内容

从节点中可以获取到数据块的编号列表。这个节点可能在缓存当中

### 访问存储文件内容的数据块

`cat`通过不断调用`read`函数来通过内核将字节从磁盘复制到内核缓冲区，进而达到用户空间

所有从文件读取数据的命令，例如`cat、cp、more、who` 等，都是将文件名传给`open` 来访访问文件内容，对`open`的每次调用都是**在目录中查找文件名，然后根据目录中的i - 节点号获得文件属性，最终找到文件内容**

如果`open`一个没有权限的文件，（文件属性里面有相应记录供内核判断），`open`会返回-1，并将全局变量`errno`的值设置成`EPERM`

## 4.3.7 i - 节点和大文件

一个i - 节点是固定长度，如何存放超大文件的doge数据块编号？**指针**！

![Untitled](%E7%AC%AC%E5%9B%9B%E7%AB%A0%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%EF%BC%9A%E7%BC%96%E5%86%99pwd%205792c1636e7548eda4404c94dabce2de/Untitled%204.png)

一个节点只能装13个项的分配链表，装不下的内容放在某个数据库中，称为**间接块**

![Untitled](%E7%AC%AC%E5%9B%9B%E7%AB%A0%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%EF%BC%9A%E7%BC%96%E5%86%99pwd%205792c1636e7548eda4404c94dabce2de/Untitled%205.png)

### 间接块也满了怎么办

创建二级间接块和三级间接块。更多就不需要了，此时应该考虑文件系统数据块的大小。

## 4.3.8 Unix文件系统的改进

一种方案是在文件 系统中创建被称为柱面组(cylinder group)的微文件系统。？

但是这个经典的模型并末过时 。文件仍旧存储在数据区的块中，文件属性仍旧存储在i 一 节点表中的i- 节点中,i- 节点包含着磁盘的分配列表;目录仅是文件名和i 节点号的列 表。现在再来回顾 一下在前面 一章中所创建和探讨的目录树。在理解了文件系统的内部结 构以后，再看目录和文件的结构就很清楚了。

# 4.4 理解目录

## 4.4.1 理解目录结构

在文件系统内部，目录是一个包含文件名与i- 节点对的列表的**文件**。从用户的角度看到的是一个文件名的列表，而从Unix的角度看到的是一个被命名的指针的列表，姐图4. 8 所示

![Untitled](%E7%AC%AC%E5%9B%9B%E7%AB%A0%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%EF%BC%9A%E7%BC%96%E5%86%99pwd%205792c1636e7548eda4404c94dabce2de/Untitled%206.png)

### “ 文件在目录中”的真正含义

简短地说，目录包含的是 文件的引用，每个引用被称为链接。文件的内容存储在数据 块 ，文件的 属性被 记 录 在 一 个 被 称 为 i 一 节 点 的 结 构 中 ，i 一 节 点 的 编 号 和 文 件 名 存 储 在 目 录 中。“ 目录包含子目录”的原理与此相同。

### “目录包含子目录”的真正含义

目录a是目录demodir的一个子目录，实际上是demodir包含有一个指向子目录a的i - 节点的链接（277），这个指向277节点的链接名字是“a“。

每个目录其实都有一个i - 节点，内核也会给每个目录一个指向自身i - 节点的入口，也就是” . “。

### “目录有一个父目录”的真正含义

“ • • ” 是 父 目 录 的 保 留 名 宇 。指向父目录的节点。

### 多重链接及链接数

在上图中，i - 节点402有两个链接：x 和 xlink。

在Unix目录结构中，这两个链接状态完全相同，称为：指向文件的**硬链接**

文件是一个i - 节点和数据块的结合； 链接是对i - 节点的引用。

可以对一个文件创建任意多的链接。

内核记录了一个文件的链接数，链接数被记录在 i - 节点中，是系统调用stat返回值[stat结构](%E7%AC%AC%E4%B8%89%E7%AB%A0%20%E7%9B%AE%E5%BD%95%E4%B8%8E%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7%EF%BC%9A%E7%BC%96%E5%86%99ls%20ad8284e7f8ac418eaf16cf1ad180858c.md)中的一个属性成员。

### 文件名

在Unixs 的文件系统中，文件没有文件名，但是链接具有名字 。文件仅仅拥有i - 节点号。 

## 4.4.2 与目录树相关的命令和系统调用

### mkdir

![Untitled](%E7%AC%AC%E5%9B%9B%E7%AB%A0%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%EF%BC%9A%E7%BC%96%E5%86%99pwd%205792c1636e7548eda4404c94dabce2de/Untitled%207.png)

`mkdir` 创建一个新的目录节点并把它链接至文件系统树。

- 创建了这个目录的i 一节点:
- **分配了一个磁盘块用以存储它的内容; //** 看来目录也是有一个数据块来存储它的内容，例如文件
- 在日录中设置两个人又:“ ”和“.• ”, 并正确 配置了它们的i- 节点号;
- 在它的父目录中增加一个该节点的链接。

### 其他命令

- rmdir
- rm： 从目录文件中删除一个记录，使用系统调用`unlink`
- ln：创建文件的链接，使用系统调用`link`
- mv： 调用`rename`
- cd：修改进程存放当前i - 节点号的变量

# 4.5 编写pwd
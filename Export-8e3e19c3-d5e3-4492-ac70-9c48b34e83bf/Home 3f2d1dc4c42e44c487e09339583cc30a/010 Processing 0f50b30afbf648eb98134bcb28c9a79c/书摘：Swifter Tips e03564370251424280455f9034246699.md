# ä¹¦æ‘˜ï¼šSwifter Tips

# @escaping

```kotlin
class S {
    var foo = "foo"

    func method1() {
        doWork {
            print(foo)
        }
        foo = "bar"
    }

    func method2() {
        doWorkAsync {
            print(self.foo)
        }
        foo = "bar"
    }

		func method3() {
		    doWorkAsync {
		        [weak self] in
		        print(self?.foo ?? "nil")
		    }
		    foo = "bar"
		}
}

S().method1() // foo
S().method2() // bar
S().method3() // nil â€œè¿™æ—¶ï¼Œåœ¨é—­åŒ…æ‰§è¡Œæ—¶å·²ç»æ²¡æœ‰å¯¹äºå®ä¾‹çš„å¼•ç”¨ï¼Œå› æ­¤è¾“å‡ºä¸º nilã€‚â€
```

method3çš„è¾“å‡ºè¿˜æ˜¯æœ‰äº›ä¸å¤ªç†è§£ğŸ¤”

<aside>
ğŸ˜µâ€ğŸ’« å› ä¸ºmethod3çš„é—­åŒ…å†…ä½¿ç”¨çš„æ˜¯[weak self]ï¼Œä¸å¯¹Så¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯selfè¿›è¡ŒæŒæœ‰ï¼Œæ‰€ä»¥åœ¨è¯¥æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ï¼Œselfå·²ç»è¢«é‡Šæ”¾ï¼Œæ‰€ä»¥æ˜¯self?.fooå˜æˆäº†nil

å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä»£ç éªŒè¯ï¼

</aside>

```swift
import UIKit
import _conCurrency

class S {
    deinit {
        print(#function)
    }
    var foo = "foo"
    
    func method1() {
        doWork {
            print(foo)
        }
        foo = "bar"
    }
    
    func method2() {
        doWorkAsync {
            print(self.foo)
        }
        foo = "bar"
        print(#function, "End")
    }
    
    func method3() {
        doWorkAsync {[weak self] in
            print(self?.foo)
        }
        foo = "bar"
        print(#function, "End")
    }
    
    private func doWork(block: () -> Void) {
        block()
    }
    
    private func doWorkAsync(block: @escaping  () -> Void) {
        DispatchQueue.main.async{
            print(#function, "Begin")
            block()
            
        }
    }
}

//S().method1()
S().method2()
//S().method3()
```

### å…³äºTaskå’ŒDispatchçš„åŒºåˆ«ï¼Ÿ

- Task{} ä¼šç›´æ¥åœ¨åŸä½ç½®æ‰§è¡Œï¼Œæ‰€ä»¥ä¸€å®šæ˜¯ç»§æ‰¿äº†å½“å‰çš„çº¿ç¨‹
    - Task.detached{} åˆ™ä¼šå¼€å¯æˆæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œ
- DispathQueue.main.async åˆ™ä¼šæŠŠä»£ç åŠ å…¥åˆ°ä½çº¿ç¨‹çš„åé¢æ‰§è¡Œ

# å‘½åç©ºé—´

Swiftä¸­å‘½åç©ºé—´æ˜¯ä»¥moduleä¸ºå•ä½çš„ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªtargetã€‚

# Typealiaså’Œæ³›å‹

Typealiasåœ¨åº”ç”¨åœ¨æ³›å‹ç›¸å…³ç±»å‹æ—¶å€™ï¼Œæ³›å‹å¿…é¡»æ˜¯å·²ç»æ˜ç¡®çš„ç±»å‹ï¼Œæˆ–è€…ä¸æ¶‰åŠæ³›å‹

### é”™è¯¯ç±»å‹

```swift
class Person<T> {}
typealias Worker = Person
typealias Worker = Person<T>
```

### æ­£ç¡®

```swift
typealias Work<T> = Person<T> //ä¸æ¶‰åŠæ³›å‹
typealias workId = String 
typealias work<workId> = Person<workId> //æ˜ç¡®äº†æ³›å‹
```

å¦ä¸€ä¸ªä½¿ç”¨åœºæ™¯æ˜¯æŸä¸ªç±»å‹åŒæ—¶å®ç°å¤šä¸ªåè®®çš„ç»„åˆæ—¶ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ & ç¬¦å·è¿æ¥å‡ ä¸ªåè®®ï¼Œç„¶ åç»™å®ƒä»¬ä¸€ä¸ªæ–°çš„æ›´ç¬¦åˆä¸Šä¸‹æ–‡çš„åå­—ï¼Œæ¥å¢å¼ºä»£ç å¯è¯»æ€§:

```swift
protocol Cat{...}
protocol Dog{...}
typealias Pat = Cat & Dog
```

# **Designated**ï¼Œ**Convenience** å’Œ **Required**

å› æ­¤è¿›è¡Œä¸€ä¸‹æ€»ç»“ï¼Œå¯ä»¥çœ‹åˆ°åˆå§‹åŒ–æ–¹æ³•æ°¸è¿œéµå¾ªä»¥ä¸‹ä¸¤ä¸ªåŸåˆ™:

1. **åˆå§‹åŒ–è·¯å¾„å¿…é¡»ä¿è¯å¯¹è±¡å®Œå…¨åˆå§‹åŒ–ï¼Œè¿™å¯ä»¥é€šè¿‡è°ƒç”¨æœ¬ç±»å‹çš„ designated åˆå§‹åŒ–æ–¹æ³•æ¥å¾—
åˆ°ä¿è¯;**
2. **å­ç±»çš„ designated åˆå§‹åŒ–æ–¹æ³•å¿…é¡»è°ƒç”¨çˆ¶ç±»çš„ designated æ–¹æ³•ï¼Œä»¥ä¿è¯çˆ¶ç±»ä¹Ÿå®Œæˆåˆå§‹
åŒ–ã€‚**

## Convenience & Required

æ‰€æœ‰çš„ `convenience` åˆå§‹åŒ–æ–¹æ³•éƒ½å¿…é¡»è°ƒç”¨åŒä¸€ä¸ªç±»ä¸­çš„ `designated` åˆå§‹åŒ–å®Œæˆè®¾ç½®

å¯¹äºæŸäº›æˆ‘ä»¬å¸Œæœ›å­ç±»ä¸­ä¸€å®šå®ç°çš„ designated åˆå§‹åŒ–æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ  `required` å…³é”® å­—è¿›è¡Œé™åˆ¶ï¼Œå¼ºåˆ¶å­ç±»å¯¹è¿™ä¸ªæ–¹æ³•é‡å†™å®ç°ã€‚è¿™æ ·åšçš„æœ€å¤§çš„å¥½å¤„æ˜¯å¯ä»¥ä¿è¯ä¾èµ–äºæŸä¸ª `designated` åˆå§‹åŒ–æ–¹æ³•çš„ `convenience` ä¸€ç›´å¯ä»¥è¢«ä½¿ç”¨ã€‚

<aside>
ğŸ’¡ Convenience â†’ designated
æ‰€ä»¥ï¼Œæ·»åŠ `required`æ¥ç¡®ä¿`designated`ä»è€Œè¿›ä¸€æ­¥å®ç°`convenience`

</aside>

# å®ä¾‹æ–¹æ³•çš„åŠ¨æ€è°ƒç”¨

```swift
class A {
    func method(number: Int) -> Int {
        return number + 1
    }
}

let object = A()
let b = A.method
b(object)(1)
```

Swift ä¸­å¯ä»¥ç›´æ¥ç”¨ Type.instanceMethod çš„è¯­æ³•æ¥ç”Ÿæˆä¸€ä¸ªå¯ä»¥æŸ¯é‡ŒåŒ–çš„æ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬è§‚å¯Ÿ f çš„ç±»å‹ (Alt + å•å‡»)ï¼Œå¯ä»¥çŸ¥é“å®ƒæ˜¯:

ç±»ä¼¼äºC++ç­‰å®ä¾‹æ–¹æ³•è°ƒç”¨ä¼šä¼ å…¥â€œthisâ€

![Untitled](%E4%B9%A6%E6%91%98%EF%BC%9ASwifter%20Tips%20e03564370251424280455f9034246699/Untitled.png)

# **C** æŒ‡é’ˆå†…å­˜ç®¡ç†

```kotlin
class MyClass {
    var a = 1
    deinit {
        print("deinit")
	}
}

var pointer: UnsafeMutablePointer<MyClass>!
pointer = UnsafeMutablePointer<MyClass>.allocate(capacity: 1)
pointer.initialize(to: MyClass())
print(pointer.pointee.a)
pointer.deinitialize()
pointer.deallocate(capacity: 1)
pointer = nil
// è¾“å‡º: // 1
// deinit
```

### åˆ›å»º

æˆ‘ä»¬å¦‚æœæƒ³è¦å£°æ˜ï¼Œåˆå§‹åŒ–ï¼Œç„¶åä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆçš„è¯ï¼Œå®Œæ•´çš„åšæ³•æ˜¯ä½¿ç”¨ allocate å’Œ initialize æ¥åˆ›å»ºã€‚

### é”€æ¯

ç”±äº UnsafeMutablePointer å¹¶ä¸ä¼šè‡ªåŠ¨è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œå›  æ­¤å…¶å® pointer æ‰€æŒ‡å‘çš„å†…å­˜æ˜¯æ²¡æœ‰è¢«é‡Šæ”¾å’Œå›æ”¶çš„ (è¿™å¯ä»¥ä» MyClass çš„ deinit æ²¡æœ‰è¢«è°ƒç”¨æ¥ åŠ ä»¥è¯å®;è¿™é€ æˆäº†å†…å­˜æ³„éœ²ã€‚æ­£ç¡®çš„åšæ³•æ˜¯ä¸º pointer åŠ å…¥ deinitialize å’Œ deallocate ï¼Œå®ƒä»¬ åˆ†åˆ«ä¼šé‡Šæ”¾æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜çš„å¯¹è±¡ä»¥åŠæŒ‡é’ˆè‡ªå·±æœ¬èº«

### åŸåˆ™

åœ¨æ‰‹åŠ¨å¤„ç†è¿™ç±»æŒ‡é’ˆçš„å†…å­˜ç®¡ç†æ—¶ï¼Œæˆ‘ä»¬éœ€è¦éµå¾ªçš„ä¸€ä¸ªåŸºæœ¬åŸåˆ™å°±æ˜¯è°åˆ›å»ºè°é‡Šæ”¾ã€‚ deallocate ä¸ deinitialize åº”è¯¥è¦å’Œ allocate ä¸ initialize æˆå¯¹å‡ºç°ï¼Œå¦‚æœä¸æ˜¯ä½ åˆ›å»ºçš„æŒ‡é’ˆï¼Œé‚£ä¹ˆä¸€èˆ¬ æ¥è¯´ä½ å°±ä¸éœ€è¦å»é‡Šæ”¾å®ƒ

# KeyPathå’ŒKVO

ç”±äº Swift ä¸ºäº†æ•ˆç‡ï¼Œé»˜è®¤ç¦ç”¨äº†åŠ¨æ€æ´¾å‘ï¼Œå› æ­¤æƒ³ç”¨ Swift æ¥å®ç° KVOï¼Œæˆ‘ä»¬è¿˜éœ€ è¦åšé¢å¤–çš„å·¥ä½œï¼Œé‚£å°±æ˜¯å°†æƒ³è¦è§‚æµ‹çš„å¯¹è±¡æ ‡è®°ä¸º dynamic å’Œ @objc ã€‚

```swift
class MyClass: NSObject {
    @objc dynamic var date = Date()
}

class AnotherClass: NSObject {
    var myObject: MyClass!
    var observation: NSKeyValueObservation?
    
    override init() {
        super.init()
        myObject = MyClass()
        
        observation = myObject.observe(\MyClass.date, options: [.new], changeHandler: { _, change in
            if let newDate = change.newValue {
                print("Date changed.")
            }
        })
        
        DispatchQueue.main.asyncAfter(deadline: .now() + 1) {
            self.myObject.date = Date()
        }
    }
}

let obj = AnotherClass()
```

# å±€éƒ¨Scope

C ç³»è¯­è¨€ä¸­åœ¨æ–¹æ³•å†…éƒ¨æˆ‘ä»¬æ˜¯å¯ä»¥ä»»æ„æ·»åŠ æˆå¯¹çš„å¤§æ‹¬å· {} æ¥é™å®šä»£ç çš„ä½œç”¨èŒƒå›´çš„ã€‚è¿™ä¹ˆåš ä¸€èˆ¬æ¥è¯´æœ‰ä¸¤ä¸ªå¥½å¤„ï¼Œé¦–å…ˆæ˜¯è¶…è¿‡ä½œç”¨åŸŸåé‡Œé¢çš„ä¸´æ—¶å˜é‡å°±å°†å¤±æ•ˆï¼Œè¿™ä¸ä»…å¯ä»¥ä½¿æ–¹æ³•å†…çš„å‘½ åæ›´åŠ å®¹æ˜“ï¼Œä¹Ÿä½¿å¾—é‚£äº›ä¸è¢«éœ€è¦çš„å¼•ç”¨çš„å›æ”¶æå‰è¿›è¡Œäº†ï¼Œå¯ä»¥ç¨å¾®æé«˜ä¸€äº›ä»£ç çš„æ•ˆç‡;å¦ å¤–ï¼Œåœ¨åˆé€‚çš„ä½ç½®æ’å…¥æ‹¬å·ä¹Ÿåˆ©äºæ–¹æ³•çš„æ¢³ç†ï¼Œå¯¹äºé‚£äº›ä¸å¤ªæ–¹ä¾¿æå–ä¸ºä¸€ä¸ªå•ç‹¬æ–¹æ³•ï¼Œä½†æ˜¯åˆ åº”è¯¥å’Œå½“å‰æ–¹æ³•å†…çš„å…¶ä»–éƒ¨åˆ†è¿›è¡Œä¸€äº›åŒºåˆ†çš„ä»£ç ï¼Œä½¿ç”¨å¤§æ‹¬å·å¯ä»¥å°†è¿™æ ·çš„ç»“æ„è¿›è¡Œä¸€ä¸ªç›¸å¯¹ è‡ªç„¶çš„åˆ’åˆ†ã€‚

å¯ä»¥åˆ©ç”¨å°¾éšé—­åŒ…çš„ç‰¹æ€§æ¨¡æ‹Ÿå±€éƒ¨ scope:

```swift
func local(_ closure: ()->()) {
    closure()
}

override func loadView() {
    let view = UIView(frame: CGRect(x: 0, y: 0, width: 320, height: 480))
    view.backgroundColor = .white
    local {
        let titleLabel = UILabel(frame: CGRect(x: 150, y: 30, width: 200, height: 40))
        titleLabel.textColor = .red
        titleLabel.text = "Title"
        view.addSubview(titleLabel)
}
    local {
        let textLabel = UILabel(frame: CGRect(x: 150, y: 80, width: 200, height: 40))
        textLabel.textColor = .red
        textLabel.text = "Text"
        view.addSubview(textLabel)
}
    self.view = view
}
```

ç”šè‡³åˆ©ç”¨do{}

```swift
do {
    let textLabel = UILabel(frame: CGRect(x: 150, y: 80, width: 200, height: 40))
    //...
}
```

# è°ƒç”¨ **C** åŠ¨æ€åº“

1. è‡ªåŠ¨æ¡¥æ¥OCå¤´æ–‡ä»¶ï¼Œæ‰€ä»¥è°ƒç”¨Cå¾ˆæ–¹ä¾¿ã€‚Swiftæ˜¯å¯ä»¥é€šè¿‡ `{product-module- name}-Bridging-Header.h` æ¥è°ƒç”¨ Objective-C ä»£ç çš„
2. åœ¨`{product-module- name}-Bridging-Header.h` ä¸­importéœ€è¦çš„Cçš„å¤´æ–‡ä»¶

### æ­¥éª¤ï¼š

- åˆ›å»ºCfileï¼Œä¼šæç¤ºåˆ›å»ºä¸€ä¸ªæ¡¥æ¥æ–‡ä»¶ //A
- åœ¨æ¡¥æ¥æ–‡ä»¶ä¸­å¼•å…¥è¯¥Cä»£ç çš„å¤´æ–‡ä»¶ //B
- æ­£å¸¸è°ƒç”¨ //C

```swift
//test.h
int test(int a); //A

//test.c
int test(int a) {
    return a + 1;
}

//Module-Bridging-Header.h //B
#import "test.h"

//File.swift
func testSwift(input: Int32) { 
    let result = test(input) //C
    print(result)
}
testSwift(1) // è¾“å‡º:2
```

# ç›´æ¥ç¼–è¯‘Swiftæ–‡ä»¶

ç›¸å¯¹äºç›´æ¥ç”¨ swift å‘½ä»¤æ‰§è¡Œï¼ŒSwift å‘½ä»¤è¡Œå·¥å…·çš„å¦ä¸€ä¸ªå¸¸ç”¨çš„åœ°æ–¹æ˜¯ç›´æ¥è„±ç¦» Xcode ç¯å¢ƒè¿›
è¡Œç¼–è¯‘å’Œç”Ÿæˆå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ swiftc æ¥è¿›è¡Œç¼–è¯‘ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­:

```swift
// MyClass.swift
class MyClass {
    let name = "XiaoMing"
    func hello() {
        print("Hello \(name)")
    }
}
// main.swift
let object = MyClass()
object.hello()
```

```swift
> swiftc MyClass.swift main.swift
// ç”Ÿæˆä¸€ä¸ªmainæ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œ
> ./main
// è¾“å‡º:
// Hello XiaoMing
```

# è®¿é—®æƒé™

å¦‚ä¸‹çš„è®¾ç½®æ–¹å¼ï¼Œå¯ä»¥åœ¨moduleä¹‹å¤–è®¿é—®åˆ°ï¼Œä½†æ˜¯åªèƒ½åœ¨å½“å‰ä½œç”¨åŸŸè¿›è¡Œè®¾ç½®

```swift
public class A {
    public private(set) var a: Int = 0
}
```

[BookNotes](../UniLabel%2030f43971c25f4cbea695984a0b8c1b6d/BookNotes%20ceb7dd18e06e4204bed6002d64ae0221.md) 

[Reference](../UniLabel%2030f43971c25f4cbea695984a0b8c1b6d/Reference%20dc0cb9e2b65640b7b4f01bf31bc8c233.md)